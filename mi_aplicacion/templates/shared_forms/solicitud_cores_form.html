{# d:\DocumentacionEmpaques\mi_aplicacion\templates\shared_forms\solicitud_cores_form.html #}
{% extends "layouts/process_base.html" %}

{% block process_title %}FO-MN-034 Solicitud de Cores V.1{% endblock %}

{% block process_head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/css4.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/solicitud_cores_form_styles.css') }}"> {# Enlace al nuevo CSS #}
{% endblock %}

{% block process_page_content %}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <a href="{{ url_for('main.home') }}">
            <i class="fas fa-home" style="margin-right: 0.25rem;"></i>
            Inicio
        </a>
        {% if proceso_origen_nombre and url_volver_proceso %}
            <span class="separator">›</span>
            <a href="{{ url_volver_proceso }}">{{ proceso_origen_nombre }}</a>
        {% endif %}
        <span class="separator">›</span>
        <span class="current-page">Solicitud de Cores</span>
    </nav>

    <div class="page-title-sub">
        <i class="fas fa-tape"></i>
        <div>
            <div>FO-MN-034 Solicitud de Cores V.1</div>
        </div>
    </div>

    <p class="page-description">Llena cada uno de los campos de información para hacer tu solicitud de cores.</p>

    {# Contenedor para las notificaciones flotantes (toasts) #}
    <div id="notification-container"></div>

    <div class="form-container">
        <form id="solicitudCoresForm" method="POST" action="{{ url_for('shared_forms.solicitud_cores_form', origen=request.args.get('origen')) }}">
            <div class="form-question-card">
                <label for="area_solicitante" class="form-label">1. Área que solicita: <span class="required-asterisk">*</span></label>
                <select id="area_solicitante" name="area_solicitante" class="form-select" required>
                    <option value="">Selecciona un área</option>
                    <option value="Extrusion Empaques" {% if area_solicitante_val == 'Extrusion Empaques' %}selected{% endif %}>Extrusión Empaques</option>
                    <option value="Impresion Empaques" {% if area_solicitante_val == 'Impresion Empaques' %}selected{% endif %}>Impresión Empaques</option>
                    <option value="Laminacion" {% if area_solicitante_val == 'Laminacion' %}selected{% endif %}>Laminación</option>
                    <option value="Corte" {% if area_solicitante_val == 'Corte' %}selected{% endif %}>Corte</option>
                    <option value="Fundas" {% if area_solicitante_val == 'Fundas' %}selected{% endif %}>Fundas</option>
                </select>
            </div>

            <div class="form-question-card">
                <label for="solicitante_id" class="form-label">2. ID de quien solicita: <span class="required-asterisk">*</span></label>
                <input type="text" id="solicitante_id" name="solicitante_id" class="form-control"
                         pattern="[0-9]{5}" maxlength="5" required
                         placeholder="Ej. 12345" value="{{ solicitante_id_val if solicitante_id_val is not none else '' }}"
                         oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
                <small class="form-text">Solo 5 dígitos numéricos.</small>
            </div>

            {# --- CAMPO MÁQUINA / REFILADORA (AHORA CASCADA Y SIEMPRE VISIBLE) --- #}
            <div class="form-question-card" id="maquina_field_container">
                <label for="maquina_refiladora" class="form-label">3. Máquina:</label>
                <select id="maquina_refiladora" name="maquina_refiladora" class="form-select">
                    <option value="">Selecciona una máquina</option>
                    {# Opciones se llenarán dinámicamente con JavaScript #}
                </select>
                <small class="form-text">Máquina que pertenece al proceso.</small>
            </div>
            {# --- FIN CAMPO MÁQUINA / REFILADORA --- #}

            <div class="form-question-card">
                <label for="trabajo_ingresa" class="form-label">4. Trabajo ingresa: <span class="required-asterisk">*</span></label>
                <input type="text" id="trabajo_ingresa" name="trabajo_ingresa" class="form-control"
                         maxlength="9" required
                         placeholder="Ej. FE000000" value="{{ trabajo_ingresa_val if trabajo_ingresa_val is not none else '' }}">
                <small class="form-text">Máximo 9 caracteres (números y texto).</small>
            </div>

            <div class="form-question-card">
                <label for="cantidad_cores" class="form-label">5. Cantidad de cores: <span class="required-asterisk">*</span></label>
                <input type="number" id="cantidad_cores" name="cantidad_cores" min="1" class="form-control" required value="{{ cantidad_cores_val if cantidad_cores_val is not none else '' }}">
                <small class="form-text">Solo números enteros positivos.</small>
            </div>

            <div class="form-question-card">
                <label for="diametro" class="form-label">6. Diámetro: <span class="required-asterisk">*</span></label>
                <select id="diametro" name="diametro" class="form-select" required>
                    <option value="">Selecciona el diámetro</option>
                    <option value="3 pulgadas" {% if diametro_val == '3 pulgadas' %}selected{% endif %}>3 pulgadas</option>
                    <option value="6 pulgadas" {% if diametro_val == '6 pulgadas' %}selected{% endif %}>6 pulgadas</option>
                    <option value="3 pulgadas de papel" {% if diametro_val == '3 pulgadas de papel' %}selected{% endif %}>3 pulgadas de papel</option>
                </select>
            </div>

            <div class="form-question-card">
                <label for="medida_mm" class="form-label">7. Medida (mm): <span class="required-asterisk">*</span></label>
                <input type="number" id="medida_mm" name="medida_mm" min="1" class="form-control" required value="{{ medida_mm_val if medida_mm_val is not none else '' }}">
                <small class="form-text">Solo números enteros positivos en milímetros.</small>
            </div>

            <div class="form-question-card">
                <label for="observaciones" class="form-label">8. Observaciones (Opcional):</label>
                <textarea id="observaciones" name="observaciones" rows="3" class="form-control">{{ observaciones_val if observaciones_val is not none else '' }}</textarea>
                <small class="form-text">Cualquier comentario adicional.</small>
            </div>

            <button type="submit" class="btn-submit">Enviar Solicitud</button>
        </form>
    </div>

    <div class="back-button-container">
        <a href="{{ url_volver_proceso or url_for('main.home') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            {% if proceso_origen_nombre %}
                Volver a Opciones de {{ proceso_origen_nombre }}
            {% else %}
                Volver
            {% endif %}
        </a>
    </div>
{% endblock %}

{% block process_page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const areaSolicitanteSelect = document.getElementById('area_solicitante');
        const maquinaRefiladoraSelect = document.getElementById('maquina_refiladora');

        // Definición de las máquinas por proceso (pasa desde el backend o hardcodea aquí si no viene de Jinja)
        // Usar JSON.parse para convertir la cadena JSON de Jinja a un objeto JavaScript
        const maquinasPorProceso = JSON.parse('{{ maquinas_por_proceso_json | tojson | safe }}'); // <-- ¡AQUÍ ESTÁ EL CAMBIO!

        // Variable para almacenar la máquina seleccionada si el formulario se repobló (después de un error)
        const selectedMaquinaRefiladoraOnLoad = "{{ maquina_refiladora_val | default('') }}";

        // Función para poblar dinámicamente el selector de Máquinas/Refiladoras
        function updateMaquinasRefiladoras() {
            const selectedArea = areaSolicitanteSelect.value;
            maquinaRefiladoraSelect.innerHTML = '<option value="">Selecciona una máquina</option>'; // Limpiar y añadir opción por defecto

            if (selectedArea && maquinasPorProceso[selectedArea]) {
                const maquinas = maquinasPorProceso[selectedArea];
                maquinas.forEach(maquina => {
                    const option = document.createElement('option');
                    option.value = maquina;
                    option.textContent = maquina;
                    // Repoblar si hay un valor guardado (después de un error de validación, por ejemplo)
                    if (maquina === selectedMaquinaRefiladoraOnLoad) {
                        option.selected = true;
                    }
                    maquinaRefiladoraSelect.appendChild(option);
                });
                // Si el área tiene máquinas, el campo es requerido en el frontend
                maquinaRefiladoraSelect.setAttribute('required', 'required');
            } else {
                // Si el área no tiene máquinas o no se seleccionó un área, el campo no es requerido
                maquinaRefiladoraSelect.removeAttribute('required');
            }
        }

        // Escuchar cambios en el selector de Área solicitante
        areaSolicitanteSelect.addEventListener('change', updateMaquinasRefiladoras);

        // Ejecutar la función al cargar la página para poblar las máquinas si ya hay un área seleccionada
        updateMaquinasRefiladoras();

        // --- Función para mostrar notificaciones flotantes (adaptada de tu código anterior) ---
        function showNotification(response) {
            const container = document.getElementById('notification-container');
            if (!container) return;
                        
            container.innerHTML = '';
                        
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${response.category} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
                        
            let icon = '';
            if (response.category === 'success') {
                icon = '<i class="fas fa-check-circle me-2"></i>';
            } else if (response.category === 'danger') {
                icon = '<i class="fas fa-exclamation-circle me-2"></i>';
            } else {
                icon = '<i class="fas fa-info-circle me-2"></i>';
            }
                        
            let messageDetails = '';
            if (response.errors && response.errors.length > 0) {
                messageDetails = `<ul class="mt-2 mb-0" style="list-style: none; padding-left: 0;">` +
                                response.errors.map(err => `<li><i class="fas fa-times-circle me-1"></i>${err}</li>`).join('') +
                                `</ul>`;
            } else if (response.details) {
                messageDetails = `<div class="small mt-1">${response.details}</div>`;
            }

            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    ${icon}
                    <div>
                        <strong>${response.message}</strong>
                        ${messageDetails}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            container.appendChild(alertDiv);

            // === DESPLAZAMIENTO SUAVE HACIA ARRIBA CUANDO HAY NOTIFICACIÓN ===
            setTimeout(() => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }, 100); // pequeño delay para asegurar que la notificación ya esté en el DOM

            // --- El resto igual que antes
            if (response.category === 'success' || response.category === 'warning') {
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    alertDiv.addEventListener('transitionend', () => alertDiv.remove());
                }, 8000);
            }
        }


        // --- Lógica AJAX para el envío del formulario ---
        const form = document.getElementById('solicitudCoresForm');
        if (form) {
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                event.stopImmediatePropagation();

                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" aria-hidden="true"></span> Enviando...`;

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                             'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.redirect_url) {
                        window.location.href = result.redirect_url;
                        return;
                    }

                    if (response.ok && result.success) {
                        showNotification(result);
                        form.reset();
                        document.querySelectorAll('select').forEach(s => {
                            if (s.querySelector('option[disabled][selected]')) {
                                s.selectedIndex = 0;
                            }
                        });
                        updateMaquinasRefiladoras();
                     } else {
                        showNotification(result);
                        updateMaquinasRefiladoras();
                     }
                } catch (error) {
                    console.error('Error en fetch:', error);
                    showNotification({
                        success: false,
                        message: 'Hubo un problema de conexión o un error inesperado.',
                        category: 'danger',
                        details: error.message || 'Verifica tu conexión a internet e inténtalo de nuevo.'
                    });
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            });

            // Prevenir envío con Enter
            form.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.tagName === 'INPUT' && activeElement.type !== 'submit') {
                        e.preventDefault();
                    }
                }
            });
        }
    });
</script>
{% endblock %}
