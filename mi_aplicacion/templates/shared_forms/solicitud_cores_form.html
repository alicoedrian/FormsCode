{% extends "layouts/process_base.html" %}

{% block process_title %}FO-MN-034 Solicitud de Cores V.1{% endblock %}

{% block process_head_css %}
<style>
    /* Estilos base del formulario */
    .page-title-sub {
        font-size: 1.8em;
        color: #2C3E50;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
    }
    .page-title-sub i.fa-tape { /* Ícono para Solicitud de Cores */
        margin-right: 12px;
        color: #795548; /* Un color marrón podría ser adecuado para cores/rollos */
    }
    .breadcrumb-nav {
        margin-bottom: 25px;
        font-size: 0.9em;
    }
    .breadcrumb-nav a { color: #007bff; text-decoration: none; }
    .breadcrumb-nav a:hover { text-decoration: underline; }
    .breadcrumb-nav .separator { margin: 0 8px; color: #6c757d; }
    .breadcrumb-nav .current-page { color: #495057; font-weight: 500; }

    /* Contenedor del formulario */
    .form-container {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        max-width: 600px; /* Ancho máximo para el formulario */
        margin: 0 auto; /* Centrar el formulario */
        border: 1px solid #e0e0e0; /* Añadido para coincidir con el diseño de mezcla */
    }

    /* Estilo para cada pregunta individual (similar a Google Forms) */
    .form-question-card {
        background-color: #fff;
        border: 1px solid #dadce0;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 20px; /* Espacio entre cada pregunta */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .form-question-card:hover {
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        border-color: #c9ccd0;
    }

    /* Estilo para el asterisco de requerido */
    .form-label .required-asterisk {
        color: #dc3545;
        margin-left: 4px;
        font-weight: normal;
    }

    /* Ajustes para inputs y selects para simetría y uniformidad */
    .form-label {
        font-weight: 400;
        color: #202124;
        font-size: 1em;
        margin-bottom: 12px;
        display: block;
    }
    .form-control, .form-select {
        width: 100%; /* Asegurar que ocupen todo el ancho */
        padding: 10px 12px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 1em;
        box-sizing: border-box; /* Incluir padding y border en el ancho total */
        min-height: 40px;
        background-color: #f8fafd;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: #1a73e8;
        outline: 0;
        box-shadow: 0 0 0 1px #1a73e8;
        background-color: #fff;
    }
    .form-text { 
        font-size: 0.85em; 
        color: #5f6368; 
        margin-top: 5px; 
    }

    /* Botones de envío */
    .btn-submit {
        background-color: #28a745; /* Verde para el botón de enviar */
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        width: 100%;
        box-sizing: border-box;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Sombra añadida */
    }
    .btn-submit:hover {
        background-color: #218838;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    /* Estilos para mensajes flash */
    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
        font-weight: 500;
    }
    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
    }

    /* Botón de volver */
    .back-button-container {
        margin-top: 25px;
        margin-bottom: 20px;
        text-align: left;
    }
    .btn-back {
        display: inline-flex;
        align-items: center;
        background-color: #6c757d;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.95em;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08); /* Sombra añadida */
    }
    .btn-back i { margin-right: 8px; }
    .btn-back:hover {
        background-color: #5a6268;
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
</style>
{% endblock %}

{% block process_page_content %}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <a href="{{ url_for('main.home') }}">Inicio (Procesos)</a>
        {% if proceso_origen_nombre and url_volver_proceso %}
            <span class="separator">&raquo;</span>
            <a href="{{ url_volver_proceso }}">{{ proceso_origen_nombre }}</a>
        {% endif %}
        <span class="separator">&raquo;</span>
        <span class="current-page">Solicitud de Cores</span>
    </nav>

    <h1 class="page-title-sub"><i class="fas fa-tape"></i>FO-MN-034 Solicitud de Cores V.1</h1>
    <p style="margin-bottom:20px;">Llena cada uno de los campos de información para hacer tu solicitud de cores.</p>

    {# Mostrar mensajes flash #}
    {# Este bloque se ocultará o eliminará si solo usas AJAX toasts #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="messages-container" style="max-width: 600px; margin: 0 auto 20px auto;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="form-container">
        <form id="solicitudCoresForm" method="POST" action="{{ url_for('shared_forms.solicitud_cores_form', origen=request.args.get('origen')) }}">

            <div class="form-question-card">
                <label for="area_solicitante" class="form-label">1. Área que solicita: <span class="required-asterisk">*</span></label>
                <select id="area_solicitante" name="area_solicitante" class="form-select" required>
                    <option value="">Selecciona un área</option>
                    <option value="Extrusion Empaques" {% if area_solicitante_val == 'Extrusion Empaques' %}selected{% endif %}>Extrusión Empaques</option>
                    <option value="Impresion Empaques" {% if area_solicitante_val == 'Impresion Empaques' %}selected{% endif %}>Impresión Empaques</option>
                    <option value="Laminacion" {% if area_solicitante_val == 'Laminacion' %}selected{% endif %}>Laminación</option>
                    <option value="Corte" {% if area_solicitante_val == 'Corte' %}selected{% endif %}>Corte</option>
                    <option value="Fundas" {% if area_solicitante_val == 'Fundas' %}selected{% endif %}>Fundas</option>
                </select>
            </div>

            <div class="form-question-card">
                <label for="solicitante_id" class="form-label">2. ID de quien solicita: <span class="required-asterisk">*</span></label>
                <input type="text" id="solicitante_id" name="solicitante_id" class="form-control" 
                        pattern="[0-9]{5}" maxlength="5" required 
                        placeholder="Ej. 12345" value="{{ solicitante_id_val if solicitante_id_val is not none else '' }}">
                <small class="form-text">Solo 5 dígitos numéricos.</small>
            </div>

            <div class="form-question-card" id="refiladora_field_container">
                <label for="refiladora" class="form-label">3. Refiladora (Solo para Corte):</label>
                <select id="refiladora" name="refiladora" class="form-select">
                    <option value="">Selecciona una refiladora (opcional)</option>
                    <option value="RF03" {% if refiladora_val == 'RF03' %}selected{% endif %}>RF03</option>
                    <option value="RF04" {% if refiladora_val == 'RF04' %}selected{% endif %}>RF04</option>
                    <option value="RF05" {% if refiladora_val == 'RF05' %}selected{% endif %}>RF05</option>
                    <option value="RF06" {% if refiladora_val == 'RF06' %}selected{% endif %}>RF06</option>
                    <option value="RF07" {% if refiladora_val == 'RF07' %}selected{% endif %}>RF07</option>
                    <option value="RF08" {% if refiladora_val == 'RF08' %}selected{% endif %}>RF08</option>
                    <option value="RF09" {% if refiladora_val == 'RF09' %}selected{% endif %}>RF09</option>
                    <option value="RF10" {% if refiladora_val == 'RF10' %}selected{% endif %}>RF10</option>
                    <option value="RF11" {% if refiladora_val == 'RF11' %}selected{% endif %}>RF11</option>
                    <option value="RF12" {% if refiladora_val == 'RF12' %}selected{% endif %}>RF12</option>
                    <option value="RF13" {% if refiladora_val == 'RF13' %}selected{% endif %}>RF13</option>
                    <option value="RF14" {% if refiladora_val == 'RF14' %}selected{% endif %}>RF14</option>
                    <option value="RF15" {% if refiladora_val == 'RF15' %}selected{% endif %}>RF15</option>
                    <option value="RF16" {% if refiladora_val == 'RF16' %}selected{% endif %}>RF16</option>
                    <option value="RF17" {% if refiladora_val == 'RF17' %}selected{% endif %}>RF17</option>
                </select>
                <small class="form-text">Este campo es obligatorio solo si el área solicitante es 'Corte'.</small>
            </div>

            <div class="form-question-card">
                <label for="trabajo_ingresa" class="form-label">4. Trabajo ingresa: <span class="required-asterisk">*</span></label>
                <input type="text" id="trabajo_ingresa" name="trabajo_ingresa" class="form-control" 
                        maxlength="9" required 
                        placeholder="Ej. FE000000" value="{{ trabajo_ingresa_val if trabajo_ingresa_val is not none else '' }}">
                <small class="form-text">Máximo 9 caracteres (números y texto).</small>
            </div>

            <div class="form-question-card">
                <label for="cantidad_cores" class="form-label">5. Cantidad de cores: <span class="required-asterisk">*</span></label>
                <input type="number" id="cantidad_cores" name="cantidad_cores" min="1" class="form-control" required value="{{ cantidad_cores_val if cantidad_cores_val is not none else '' }}">
                <small class="form-text">Solo números enteros positivos.</small>
            </div>

            <div class="form-question-card">
                <label for="diametro" class="form-label">6. Diámetro: <span class="required-asterisk">*</span></label>
                <select id="diametro" name="diametro" class="form-select" required>
                    <option value="">Selecciona el diámetro</option>
                    <option value="3 pulgadas" {% if diametro_val == '3 pulgadas' %}selected{% endif %}>3 pulgadas</option>
                    <option value="6 pulgadas" {% if diametro_val == '6 pulgadas' %}selected{% endif %}>6 pulgadas</option>
                    <option value="3 pulgadas de papel" {% if diametro_val == '3 pulgadas de papel' %}selected{% endif %}>3 pulgadas de papel</option>
                </select>
            </div>

            <div class="form-question-card">
                <label for="medida_mm" class="form-label">7. Medida (mm): <span class="required-asterisk">*</span></label>
                <input type="number" id="medida_mm" name="medida_mm" min="1" class="form-control" required value="{{ medida_mm_val if medida_mm_val is not none else '' }}">
                <small class="form-text">Solo números enteros positivos en milímetros.</small>
            </div>

            <div class="form-question-card">
                <label for="observaciones" class="form-label">8. Observaciones (Opcional):</label>
                <textarea id="observaciones" name="observaciones" rows="3" class="form-control">{{ observaciones_val if observaciones_val is not none else '' }}</textarea>
                <small class="form-text">Cualquier comentario adicional.</small>
            </div>

            <button type="submit" class="btn-submit">Enviar Solicitud</button>
        </form>
    </div>

    <div class="back-button-container">
        <a href="{{ url_volver_proceso or url_for('main.home') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            {% if proceso_origen_nombre %}
                Volver a Opciones de {{ proceso_origen_nombre }}
            {% else %}
                Volver
            {% endif %}
        </a>
    </div>
{% endblock %}

{% block process_page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ... (Tu código JavaScript para toggleRefiladoraField y showNotification) ...
        const areaSolicitanteSelect = document.getElementById('area_solicitante');
        const refiladoraFieldContainer = document.getElementById('refiladora_field_container');
        const refiladoraSelect = document.getElementById('refiladora');

        // Función para mostrar/ocultar el campo de Refiladora y establecer su obligatoriedad
        function toggleRefiladoraField() {
            const selectedArea = areaSolicitanteSelect.value;
            if (selectedArea === 'Corte') {
                refiladoraFieldContainer.style.display = 'block';
                refiladoraSelect.setAttribute('required', 'required');
            } else {
                refiladoraFieldContainer.style.display = 'none';
                refiladoraSelect.removeAttribute('required');
                refiladoraSelect.value = ''; // Limpiar la selección si no es obligatoria
            }
        }

        areaSolicitanteSelect.addEventListener('change', toggleRefiladoraField);
        toggleRefiladoraField(); // Llamar al cargar para establecer el estado inicial

        // --- Función para mostrar notificaciones flotantes (adaptada de tu código anterior) ---
        function showNotification(response) {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            container.innerHTML = ''; // Limpiar notificaciones anteriores
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${response.category} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            
            let icon = '';
            if (response.category === 'success') {
                icon = '<i class="fas fa-check-circle me-2"></i>';
            } else if (response.category === 'danger') {
                icon = '<i class="fas fa-exclamation-circle me-2"></i>';
            } else {
                icon = '<i class="fas fa-info-circle me-2"></i>';
            }
            
            let messageDetails = '';
            if (response.errors && response.errors.length > 0) {
                // Si hay una lista de errores (ej. de validación backend)
                messageDetails = `<ul class="mt-2 mb-0" style="list-style: none; padding-left: 0;">` +
                                 response.errors.map(err => `<li><i class="fas fa-times-circle me-1"></i>${err}</li>`).join('') +
                                 `</ul>`;
            } else if (response.details) {
                // Para detalles generales (ej. de éxito o error no de validación)
                messageDetails = `<div class="small mt-1">${response.details}</div>`;
            }

            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    ${icon}
                    <div>
                        <strong>${response.message}</strong>
                        ${messageDetails}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            container.appendChild(alertDiv);
            
            // Auto-eliminar después de 8 segundos si es de éxito
            if (response.category === 'success') {
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    alertDiv.addEventListener('transitionend', () => alertDiv.remove());
                }, 8000);
            }
        }

        // --- Lógica AJAX para el envío del formulario ---
        const form = document.getElementById('solicitudCoresForm'); // Asegúrate de que el ID del formulario en HTML sea este
        if (form) {
            form.addEventListener('submit', async function(event) {
                event.preventDefault(); // Evita el envío tradicional
                event.stopImmediatePropagation(); // Detiene la propagación del evento

                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" aria-hidden="true"></span> Enviando...`;

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest' // Para que Flask pueda detectar que es AJAX
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json(); // Intentar parsear siempre como JSON

                    if (response.ok && result.success) {
                        showNotification(result);
                        form.reset(); // Limpia el formulario si es exitoso
                        document.querySelectorAll('select').forEach(s => s.selectedIndex = 0); // Reset selects
                        // Volver a establecer el campo de refiladora si es necesario después del reset
                        toggleRefiladoraField(); 
                    } else {
                        // Si response.ok es false (error HTTP) o result.success es false (error de validación/lógica)
                        // result ya contiene el mensaje y la categoría.
                        showNotification(result);
                    }
                } catch (error) {
                    console.error('Error en fetch:', error);
                    showNotification({
                        success: false,
                        message: 'Hubo un problema de conexión o un error inesperado.',
                        category: 'danger',
                        details: error.message || 'Verifica tu conexión a internet e inténtalo de nuevo.'
                    });
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            });

            // Prevenir envío con Enter
            form.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') e.preventDefault();
            });
        }
    });
</script>
{% endblock %}