{% extends "layouts/process_base.html" %}

{% block process_title %}Despeje de Línea – {{ nombre_proceso }}{% endblock %}

{% block process_head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/css4.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/monitoreo_cuchillas_form_styles.css') }}">
{% endblock %}

{% block process_page_content %}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <a href="{{ url_for('main.home') }}">
            <i class="fas fa-home" style="margin-right: 0.25rem;"></i>
            Inicio
        </a>
        {% if proceso_origen_nombre and url_volver_proceso %}
            <span class="separator">›</span>
            <a href="{{ url_volver_proceso }}">{{ proceso_origen_nombre }}</a>
        {% endif %}
        <span class="separator">›</span>
        <span class="current-page">Monitoreo de cuchillas</span>
    </nav>

    <h1 class="page-title-sub"><i class="fas fa-cogs"></i> {{ subseccion }}</h1>
    <p class="mb-5 text-secondary">Registre el monitoreo de las cuchillas.</p>

    <div id="notification-container" class="notification-container"></div>

    <div class="custom-form-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form id="monitoreoCuchillasForm" method="POST" action="{{ url_for('monitoreo_cuchillas.monitoreo_cuchillas_form', origen=proceso_origen) }}">
            <fieldset>
                <legend>Datos del Monitoreo</legend>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fecha" class="form-label">Fecha:</label>
                            <input type="text" class="form-control" name="fecha" id="fecha" value="{{ fecha_actual }}" readonly>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="proceso_seleccionado" class="form-label">Proceso:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="proceso_seleccionado" name="proceso_seleccionado" required>
                                <option value="">Seleccione un proceso</option>
                                <option value="Extrusion" {% if form_data.proceso_seleccionado == 'Extrusion' %}selected{% endif %} {% if (proceso_origen|capitalize == 'Extrusion') and (form_data.proceso_seleccionado is none or form_data.proceso_seleccionado == '') %}selected{% endif %}>Extrusion</option>
                                <option value="Corte" {% if form_data.proceso_seleccionado == 'Corte' %}selected{% endif %} {% if (proceso_origen|capitalize == 'Corte') and (form_data.proceso_seleccionado is none or form_data.proceso_seleccionado == '') %}selected{% endif %}>Corte</option>
                                <option value="Sellado" {% if form_data.proceso_seleccionado == 'Sellado' %}selected{% endif %} {% if (proceso_origen|capitalize == 'Sellado') and (form_data.proceso_seleccionado is none or form_data.proceso_seleccionado == '') %}selected{% endif %}>Sellado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="maquina" class="form-label">Máquina:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="maquina" name="maquina" required>
                                <option value="">Seleccione una máquina</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="id_operario" class="form-label">ID Operario:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="5" class="form-control" id="id_operario" name="id_operario"
                                oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                onchange="consultarOperarioPorID()" 
                                value="{{ form_data.id_operario if form_data.id_operario is not none else '' }}" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="nombre_operario" class="form-label">Nombre Operario:</label>
                            <input type="text" class="form-control" id="nombre_operario" name="nombre_operario" 
                                value="{{ form_data.nombre_operario if form_data.nombre_operario is not none else '' }}" readonly>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="turno" class="form-label">Turno:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="turno" name="turno" required>
                                <option value="">Seleccione un turno</option>
                                <option value="TURNO 1 (9:30PM - 5:30AM)" {% if form_data.turno == 'TURNO 1 (9:30PM - 5:30AM)' %}selected{% endif %}>TURNO 1 (9:30PM - 5:30AM)</option>
                                <option value="TURNO 2 (5:30AM - 1:30 PM)" {% if form_data.turno == 'TURNO 2 (5:30AM - 1:30 PM)' %}selected{% endif %}>TURNO 2 (5:30AM - 1:30 PM)</option>
                                <option value="TURNO 3 (1:30 PM - 9:30 PM)" {% if form_data.turno == 'TURNO 3 (1:30 PM - 9:30 PM)' %}selected{% endif %}>TURNO 3 (1:30 PM - 9:30 PM)</option>
                                <option value="TURNO L-J (DIURNO)" {% if form_data.turno == 'TURNO L-J (DIURNO)' %}selected{% endif %}>TURNO L-J (DIURNO)</option>
                                <option value="TURNO L-J (NOCTURNO)" {% if form_data.turno == 'TURNO L-J (NOCTURNO)' %}selected{% endif %}>TURNO L-J (NOCTURNO)</option>
                                <option value="TURNO V-D (DIURNO)" {% if form_data.turno == 'TURNO V-D (DIURNO)' %}selected{% endif %}>TURNO V-D (DIURNO)</option>
                                <option value="TURNO V-D (NOCTURNO)" {% if form_data.turno == 'TURNO V-D (NOCTURNO)' %}selected{% endif %}>TURNO V-D (NOCTURNO)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="cuchilla_cantidad" class="form-label">Cuchillas (Cantidad):<span class="required-asterisk">*</span></label>
                            <input type="number" min="0" class="form-control" id="cuchilla_cantidad" name="cuchilla_cantidad"
                                value="{{ form_data.cuchilla_cantidad if form_data.cuchilla_cantidad is not none else '0' }}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label class="form-label">Número de cuchillas en máquina:</label>
                            <input type="text" class="form-control" id="cuchillas_en_maquina_static" name="cuchillas_en_maquina_static"
                                value="{{ form_data.numero_cuchillas_maquina if form_data.numero_cuchillas_maquina is not none else '' }}" readonly>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="numero_cuchillas_maquina" name="numero_cuchillas_maquina" value="{{ form_data.numero_cuchillas_maquina if form_data.numero_cuchillas_maquina is not none else '' }}">
            </fieldset>

            <fieldset>
                <legend>Estado de Cuchillas (Cantidad)</legend>
                <div class="cuchillas-estado-grid">
                    <table class="cuchillas-table">
                        <thead>
                            <tr>
                                <th>Estado</th>
                                <th>Cantidad<span class="required-asterisk">*</span></th>
                                <th style="width: 40%;">Acciones tomadas</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Cumple</td>
                                <td>
                                    <input type="number" min="0" class="form-control estado-cuchilla-input" 
                                        name="estado_cuchilla_cumple_cantidad" 
                                        id="estado_cuchilla_cumple_cantidad" 
                                        value="{{ form_data['estado_cuchilla_cumple_cantidad'] if form_data['estado_cuchilla_cumple_cantidad'] is not none else '0' }}" required>
                                </td>
                                <td></td>
                            </tr>
                            <tr class="additional-cuchillas-row" style="display: none;">
                                <td>Caso de Oxido</td>
                                <td>
                                    <input type="number" min="0" class="form-control estado-cuchilla-input" 
                                        name="estado_cuchilla_caso_oxidacion_cantidad" 
                                        id="estado_cuchilla_caso_oxidacion_cantidad" 
                                        value="{{ form_data['estado_cuchilla_caso_oxidacion_cantidad'] if form_data['estado_cuchilla_caso_oxidacion_cantidad'] is not none else '0' }}" required>
                                </td>
                                <td>
                                    <select class="form-select acciones-select" id="acciones_oxidacion" name="acciones_oxidacion" disabled>
                                        </select>
                                </td>
                            </tr>
                            <tr class="additional-cuchillas-row" style="display: none;">
                                <td>Caso de Perdida</td>
                                <td>
                                    <input type="number" min="0" class="form-control estado-cuchilla-input" 
                                        name="estado_cuchilla_caso_perdida_cantidad" 
                                        id="estado_cuchilla_caso_perdida_cantidad" 
                                        value="{{ form_data['estado_cuchilla_caso_perdida_cantidad'] if form_data['estado_cuchilla_caso_perdida_cantidad'] is not none else '0' }}" required>
                                </td>
                                <td>
                                    <select class="form-select acciones-select" id="acciones_perdida" name="acciones_perdida" disabled>
                                        </select>
                                </td>
                            </tr>
                            <tr class="additional-cuchillas-row" style="display: none;">
                                <td>Fractura</td>
                                <td>
                                    <input type="number" min="0" class="form-control estado-cuchilla-input" 
                                        name="estado_cuchilla_fractura_cantidad" 
                                        id="estado_cuchilla_fractura_cantidad" 
                                        value="{{ form_data['estado_cuchilla_fractura_cantidad'] if form_data['estado_cuchilla_fractura_cantidad'] is not none else '0' }}" required>
                                </td>
                                <td>
                                    <select class="form-select acciones-select" id="acciones_fractura" name="acciones_fractura" disabled>
                                        </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </fieldset>

            <fieldset>
                <legend>Entrega de Cuchillas</legend>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="id_quien_recibe" class="form-label">ID Quien Recibe:</label>
                            <input type="text" maxlength="5" class="form-control" id="id_quien_recibe" name="id_quien_recibe"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                            onchange="consultarQuienRecibePorID()" 
                            value="{{ form_data.id_quien_recibe if form_data.id_quien_recibe is not none else '' }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="nombre_quien_recibe" class="form-label">Nombre Quien Recibe:</label>
                            <input type="text" class="form-control" id="nombre_quien_recibe" name="nombre_quien_recibe" 
                                value="{{ form_data.nombre_quien_recibe if form_data.nombre_quien_recibe is not none else '' }}" readonly>
                        </div>
                    </div>
                </div>
            </fieldset>
            
            <button type="submit" class="btn-submit">
                <i class="fas fa-save"></i> Registrar
            </button>
        </form>
    </div>

    <div class="back-button-container">
        <a href="{{ url_volver }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Volver a {{ nombre_proceso }}
        </a>
    </div>
{% endblock %}

{% block process_page_scripts %}
<script id="form-data-json" type="application/json">
    {{ form_data | tojson | safe }}
</script>

<script>
const formDataSourceElement = document.getElementById('form-data-json');
const currentFormData = formDataSourceElement ? JSON.parse(formDataSourceElement.textContent) : {};

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('monitoreoCuchillasForm');
    const notify = document.getElementById('notification-container');
    const procesoSeleccionadoSelect = document.getElementById('proceso_seleccionado');
    const maquinaSelect = document.getElementById('maquina');
    const turnoSelect = document.getElementById('turno'); // Nuevo: Referencia al selector de turno
    const idOperarioInput = document.getElementById('id_operario');
    const nombreOperarioInput = document.getElementById('nombre_operario');
    const idQuienRecibeInput = document.getElementById('id_quien_recibe');
    const nombreQuienRecibeInput = document.getElementById('nombre_quien_recibe');
    const cuchillaCantidadInput = document.getElementById('cuchilla_cantidad');
    const cumpleCantidadInput = document.getElementById('estado_cuchilla_cumple_cantidad');
    const additionalCuchillasRows = document.querySelectorAll('.additional-cuchillas-row');
    const estadoCuchillaInputs = document.querySelectorAll('.estado-cuchilla-input');

    const oxidacionCantidadInput = document.getElementById('estado_cuchilla_caso_oxidacion_cantidad');
    const perdidaCantidadInput = document.getElementById('estado_cuchilla_caso_perdida_cantidad');
    const fracturaCantidadInput = document.getElementById('estado_cuchilla_fractura_cantidad');
    const accionesOxidacionSelect = document.getElementById('acciones_oxidacion');
    const accionesPerdidaSelect = document.getElementById('acciones_perdida');
    const accionesFracturaSelect = document.getElementById('acciones_fractura');
    
    // Campo estático de cuchillas por máquina
    const cuchillasEnMaquinaInput = document.getElementById('cuchillas_en_maquina_static');

    if (!form || !notify || !procesoSeleccionadoSelect || !maquinaSelect || !idOperarioInput || !nombreOperarioInput || !idQuienRecibeInput || !nombreQuienRecibeInput || !cuchillaCantidadInput || !cumpleCantidadInput || estadoCuchillaInputs.length === 0 || !cuchillasEnMaquinaInput || !turnoSelect) {
        console.error("Faltan elementos HTML esenciales para el script.");
        return;
    }
    
    // --- NUEVO: Valores estáticos de cuchillas por máquina ---
    const CUCHILLAS_POR_MAQUINA = {
        "Corte": {
            "default": 14, // Asumimos que todas las máquinas de corte tienen 14 por defecto. Si hay variaciones, deben listarse
            "RF01": 14, "RF02": 14, "RF03": 14, "RF04": 14, "RF05": 14, "RF06": 14, "RF07": 14, "RF08": 14, "RF09": 14, "RF10": 14, "RF11": 14, "RF12": 14, "RF13": 14, "RF14": 14, "RF15": 14, "RF16": 14, "RF17": 14
        },
        "Extrusion": {
            "EX05": 8,
            "EX07": 8,
            "EX11": 8,
            "EX12": 10,
            "EX13": 30,
            "EX14": 30
        },
        "Sellado": {
            "SE11": 3,
            "SE14": 3,
            "SE15": 3,
            "SE16": 3,
            "SE18": 4,
            "SE19": 3,
            "SE20": 3,
            "SE23": 3,
            "SE25": 3,
            "SE26": 3,
            "SE30": 6,
            "SE31": 4,
            "SE34": 3,
            "SE35": 3,
            "SE38": 3,
            "SE41": 3,
            "SE42": 3,
            "SE45": 3,
            "SE46": 3,
            "SE47": 7,
            "SE50": 3,
            "SE52": 3,
            "SE55": 3,
            "SE56": 3
        }
    };

    // --- NUEVO: Turnos por proceso ---
    const TURNOS_POR_PROCESO = {
        "Corte": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" }
        ],
        "Sellado": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" }
        ],
        "Extrusion": [
            { value: "TURNO L-J (DIURNO)", text: "TURNO L-J (DIURNO)" },
            { value: "TURNO L-J (NOCTURNO)", text: "TURNO L-J (NOCTURNO)" },
            { value: "TURNO V-D (DIURNO)", text: "TURNO V-D (DIURNO)" },
            { value: "TURNO V-D (NOCTURNO)", text: "TURNO V-D (NOCTURNO)" }
        ]
    };
    
    // --- Definición de opciones y NA ---
    const ACCIONES_OPCIONES = [
        { value: "Búsqueda en la máquina, periféricos y sistema de refile", text: "Búsqueda en la máquina, periféricos y sistema de refile." },
        { value: "Reporte de la novedad al coordinador, analista de calidad o líder.", text: "Reporte de la novedad al coordinador, analista de calidad o líder." },
        { value: "Retención del producto desde la última inspección conforme.", text: "Retención del producto desde la última inspección conforme." },
        { value: "Se separa el producto no conforme y realizar cambio de embobinado, se usa FO-MN-007 Retenido.", text: "Se separa el producto no conforme y realizar cambio de embobinado, se usa FO-MN-007 Retenido." },
        { value: "Se realiza cambio de cuchilla", text: "Se realiza cambio de cuchilla" }
    ];
    const NA_OPCION = { value: "NA", text: "NA" };

    // --- Funciones de ayuda ---
    function populateSelectWithOptions(selectElement, options, selectedValue = null) {
        selectElement.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "Seleccione una opción";
        selectElement.appendChild(defaultOption);

        options.forEach(optionData => {
            const option = document.createElement('option');
            option.value = optionData.value;
            option.textContent = optionData.text;
            if (selectedValue && selectedValue === optionData.value) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }

    function toggleActions(cantidadInput, selectElement) {
        const cantidad = parseInt(cantidadInput.value, 10) || 0;
        
        if (cantidad > 0) {
            selectElement.disabled = false;
            // Se puede agregar un valor seleccionado del form_data si existe
            const selectedActionValue = currentFormData[selectElement.id];
            populateSelectWithOptions(selectElement, ACCIONES_OPCIONES, selectedActionValue);
        } else {
            selectElement.disabled = true;
            populateSelectWithOptions(selectElement, [NA_OPCION], 'NA');
        }
    }
    
    // --- Lógica de la aplicación ---
    const MAQUINAS_POR_PROCESO_JS = {
        "Extrusion": ["EX05", "EX07", "EX11", "EX12", "EX13", "EX14"],
        "Corte": ["RF01", "RF02", "RF03", "RF04", "RF05", "RF06", "RF07", "RF08", "RF09", "RF10", "RF11", "RF12", "RF13", "RF14", "RF15", "RF16", "RF17"],
        "Sellado": ["SE11", "SE14", "SE15", "SE16", "SE18", "SE19", "SE20", "SE23", "SE25", "SE26", "SE30", "SE31", "SE34", "SE35", "SE38", "SE41", "SE42", "SE45", "SE46", "SE47", "SE50", "SE52", "SE55", "SE56"],
    };

    window.updateTurnosDropdown = function() {
        const selectedProcessName = procesoSeleccionadoSelect.value;
        const turnosOptions = TURNOS_POR_PROCESO[selectedProcessName] || [];
        
        turnoSelect.innerHTML = '<option value="">Seleccione un turno</option>';

        if (turnosOptions.length > 0) {
            turnosOptions.forEach(turno => {
                const option = document.createElement('option');
                option.value = turno.value;
                option.textContent = turno.text;
                if (currentFormData.turno === turno.value) {
                    option.selected = true;
                }
                turnoSelect.appendChild(option);
            });
        }
    };

    window.updateMaquinasDropdown = function() {
        const selectedProcessName = procesoSeleccionadoSelect.value;
        maquinaSelect.innerHTML = '<option value="">Seleccione una máquina</option>';

        if (selectedProcessName && MAQUINAS_POR_PROCESO_JS[selectedProcessName]) {
            const maquinas = MAQUINAS_POR_PROCESO_JS[selectedProcessName];
            maquinas.forEach(maquina => {
                const option = document.createElement('option');
                option.value = maquina;
                option.textContent = maquina;
                if (currentFormData.maquina === maquina) {
                    option.selected = true;
                }
                maquinaSelect.appendChild(option);
            });
        }
        
        // Actualiza el dropdown de turnos
        window.updateTurnosDropdown();
        
        // **NUEVO:** Actualiza el campo estático de cuchillas por máquina
        window.updateCuchillasEnMaquina();
    };
    
    // **NUEVA FUNCIÓN:** Para actualizar el campo estático de cuchillas por máquina
    window.updateCuchillasEnMaquina = function() {
        const selectedProcess = procesoSeleccionadoSelect.value;
        const selectedMachine = maquinaSelect.value;
        
        const hiddenCuchillasInput = document.getElementById('numero_cuchillas_maquina');

        let cuchillasCount = 'NA';
        if (selectedProcess && CUCHILLAS_POR_MAQUINA[selectedProcess]) {
            if (selectedProcess === "Corte") {
                cuchillasCount = CUCHILLAS_POR_MAQUINA[selectedProcess]["default"];
            } else if (selectedMachine && CUCHILLAS_POR_MAQUINA[selectedProcess][selectedMachine] !== undefined) {
                cuchillasCount = CUCHILLAS_POR_MAQUINA[selectedProcess][selectedMachine];
            }
        }
        
        cuchillasEnMaquinaInput.value = cuchillasCount;
        hiddenCuchillasInput.value = cuchillasCount === 'NA' ? '' : cuchillasCount; // Asigna el valor al campo oculto
    };

    window.consultarOperarioPorID = async function() {
        const id = idOperarioInput.value;
        if (!id) {
            nombreOperarioInput.value = "";
            return;
        }
        try {
            const response = await fetch(`/shared/api/empleado?id=${id}`);
            const data = await response.json();
            if (response.ok && data.success) {
                nombreOperarioInput.value = data.nombre || 'No encontrado';
            } else {
                nombreOperarioInput.value = data.nombre || 'No encontrado';
            }
        } catch (error) {
            console.error("Error al consultar el ID Operario:", error);
            nombreOperarioInput.value = "Error en la consulta";
        }
    };
    
    window.consultarQuienRecibePorID = async function() {
        const id = idQuienRecibeInput.value;
        if (!id) {
            nombreQuienRecibeInput.value = "";
            return;
        }
        try {
            const response = await fetch(`/shared/api/empleado?id=${id}`);
            const data = await response.json();
            if (response.ok && data.success) {
                nombreQuienRecibeInput.value = data.nombre || 'No encontrado';
            } else {
                nombreQuienRecibeInput.value = data.nombre || 'No encontrado';
            }
        } catch (error) {
            console.error("Error al consultar el ID Quien Recibe:", error);
            nombreQuienRecibeInput.value = "Error en la consulta";
        }
    };
    
    window.toggleAdditionalFields = function() {
        const cuchillaCantidad = parseInt(cuchillaCantidadInput.value, 10) || 0;
        const cumpleCantidad = parseInt(cumpleCantidadInput.value, 10) || 0;
        const cumpleValor = cumpleCantidadInput.value;

        if (cumpleValor === '' || cumpleCantidad >= cuchillaCantidad) {
            additionalCuchillasRows.forEach(row => {
                row.style.display = 'none';
            });
            document.getElementById('estado_cuchilla_caso_oxidacion_cantidad').value = 0;
            document.getElementById('estado_cuchilla_caso_perdida_cantidad').value = 0;
            document.getElementById('estado_cuchilla_fractura_cantidad').value = 0;

            toggleActions(oxidacionCantidadInput, accionesOxidacionSelect);
            toggleActions(perdidaCantidadInput, accionesPerdidaSelect);
            toggleActions(fracturaCantidadInput, accionesFracturaSelect);
        } else {
            additionalCuchillasRows.forEach(row => {
                row.style.display = 'table-row';
            });
            toggleActions(oxidacionCantidadInput, accionesOxidacionSelect);
            toggleActions(perdidaCantidadInput, accionesPerdidaSelect);
            toggleActions(fracturaCantidadInput, accionesFracturaSelect);
        }
    };
    
    function showNotification(response) {
        const container = document.getElementById('notification-container');
        if (!container) return;

        container.innerHTML = '';

        const alert = document.createElement('div');
        alert.className = `alert alert-${response.category || 'info'} alert-dismissible`;
        let icon = '';
        if (response.category === 'success') {
            icon = '<i class="fas fa-check-circle me-2"></i>';
        } else if (response.category === 'danger') {
            icon = '<i class="fas fa-exclamation-circle me-2"></i>';
        } else if (response.category === 'warning') {
            icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
        } else {
            icon = '<i class="fas fa-info-circle me-2"></i>';
        }
        let detailsHtml = '';
        if (response.details) {
            detailsHtml = `<div class="small mt-1">${response.details}</div>`;
        }
        alert.innerHTML = `
            <div class="d-flex align-items-center">
                ${icon}
                <div>
                    <strong>${response.message}</strong>
                    ${detailsHtml}
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        container.appendChild(alert);

        alert.querySelector('.btn-close').onclick = () => alert.remove();

        setTimeout(function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);

        if (['success', 'warning'].includes(response.category)) {
            setTimeout(() => { if (alert.parentNode) alert.remove(); }, 8000);
        }
    }

    procesoSeleccionadoSelect.addEventListener('change', () => {
        window.updateMaquinasDropdown();
        // Cuando se cambia el proceso, el número de cuchillas en máquina debe actualizarse, aunque la máquina no esté seleccionada.
        // La función `updateMaquinasDropdown` ya llama a `updateCuchillasEnMaquina` al final, por lo que no es necesario aquí.
    });
    
    // Nuevo evento para actualizar el número de cuchillas cuando se cambia la máquina
    maquinaSelect.addEventListener('change', () => {
        window.updateCuchillasEnMaquina();
    });

    idOperarioInput.addEventListener('change', window.consultarOperarioPorID);
    idQuienRecibeInput.addEventListener('change', window.consultarQuienRecibePorID);
    
    cuchillaCantidadInput.addEventListener('input', window.toggleAdditionalFields);
    cumpleCantidadInput.addEventListener('input', window.toggleAdditionalFields);
    
    oxidacionCantidadInput.addEventListener('input', () => toggleActions(oxidacionCantidadInput, accionesOxidacionSelect));
    perdidaCantidadInput.addEventListener('input', () => toggleActions(perdidaCantidadInput, accionesPerdidaSelect));
    fracturaCantidadInput.addEventListener('input', () => toggleActions(fracturaCantidadInput, accionesFracturaSelect));

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        
        const cuchillaCantidad = parseInt(cuchillaCantidadInput.value, 10) || 0;
        let sumEstadoCuchillas = 0;
        estadoCuchillaInputs.forEach(input => {
            sumEstadoCuchillas += parseInt(input.value, 10) || 0;
        });

        if (sumEstadoCuchillas !== cuchillaCantidad) {
            showNotification({
                category: 'danger',
                message: 'Error de validación.',
                details: 'La suma de las cuchillas por estado debe ser exactamente igual a la cantidad total de cuchillas.'
            });
            return;
        }

        const btn = form.querySelector('button[type="submit"]');
        const origText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" aria-hidden="true"></span> Enviando...`;

        const payload = {};
        new FormData(form).forEach((value, key) => {
            if (key.endsWith('_cantidad') || key === 'id_operario' || key === 'id_quien_recibe') {
                payload[key] = value === '' || isNaN(parseInt(value, 10)) ? 0 : parseInt(value, 10);
            } else {
                payload[key] = value;
            }
        });
        
        ['acciones_oxidacion', 'acciones_perdida', 'acciones_fractura'].forEach(name => {
            const selectElement = document.getElementById(name);
            if (selectElement) {
                payload[name] = selectElement.value;
                if (payload[name] === 'NA') {
                    payload[name] = null;
                }
            }
        });
        
        try {
            const res = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            showNotification(result);

            if (res.ok && result.success) {
                form.reset();
                nombreOperarioInput.value = "";
                nombreQuienRecibeInput.value = "";
                procesoSeleccionadoSelect.value = "{{ proceso_origen|capitalize }}";
                window.updateMaquinasDropdown();
                window.toggleAdditionalFields();
            } else {
                if (result.form_data) {
                    for (const key in result.form_data) {
                        const input = document.getElementById(key);
                        if (input) {
                            input.value = result.form_data[key];
                        } else {
                            const select = document.querySelector(`select[name="${key}"]`);
                            if (select) {
                                select.value = result.form_data[key];
                            }
                        }
                    }
                    procesoSeleccionadoSelect.value = currentFormData.proceso_seleccionado || "{{ proceso_origen|capitalize }}";
                    window.updateMaquinasDropdown();
                    if (currentFormData.maquina) {
                        maquinaSelect.value = currentFormData.maquina;
                    }
                    if (idOperarioInput.value) consultarOperarioPorID();
                    if (idQuienRecibeInput.value) consultarQuienRecibePorID();
                    
                    toggleActions(oxidacionCantidadInput, accionesOxidacionSelect);
                    toggleActions(perdidaCantidadInput, accionesPerdidaSelect);
                    toggleActions(fracturaCantidadInput, accionesFracturaSelect);
                }
            }
        } catch (err) {
            console.error('AJAX error:', err);
            showNotification({
                category: 'danger',
                message: 'Error de red o servidor.',
                details: 'Por favor, verifica tu conexión a internet e inténtalo de nuevo.'
            });
        } finally {
            btn.disabled = false;
            btn.innerHTML = origText;
        }
    });

    form.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName === 'INPUT' && e.target.type !== 'submit') {
            e.preventDefault();
        }
    });

    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('wheel', e => e.preventDefault());
    });

    // --- Inicialización ---
    const initialProcessValue = currentFormData.proceso_seleccionado || "{{ proceso_origen|capitalize }}";
    procesoSeleccionadoSelect.value = initialProcessValue;
    window.updateMaquinasDropdown();
    if (currentFormData.maquina) {
        maquinaSelect.value = currentFormData.maquina;
        window.updateCuchillasEnMaquina();
    }
    window.updateTurnosDropdown();
    if (currentFormData.turno) {
        turnoSelect.value = currentFormData.turno;
    }
    if (idOperarioInput.value) consultarOperarioPorID();
    if (idQuienRecibeInput.value) consultarQuienRecibePorID();
    
    window.toggleAdditionalFields();
    
    toggleActions(oxidacionCantidadInput, accionesOxidacionSelect);
    toggleActions(perdidaCantidadInput, accionesPerdidaSelect);
    toggleActions(fracturaCantidadInput, accionesFracturaSelect);
});
</script>

{% endblock %}