{# d:\DocumentacionEmpaques\mi_aplicacion\templates\empalme_turno\empalme_turno_form.html #}
{% extends "layouts/process_base.html" %}

{% block process_title %}Checklist 5S - Empalme de Turno{% endblock %}

{% block process_head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/css4.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/empalme_turno_form_styles.css') }}">
{% endblock %}

{% block process_page_content %}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <a href="{{ url_for('main.home') }}">
            <i class="fas fa-home" style="margin-right: 0.25rem;"></i>
            Inicio
        </a>
        {% if proceso_origen_nombre and url_volver_proceso %}
            <span class="separator">›</span>
            <a href="{{ url_volver_proceso }}">{{ proceso_origen_nombre }}</a>
        {% endif %}
        <span class="separator">›</span>
        <span class="current-page">Checklist Empalme de Turno</span>
    </nav>

    <div class="page-title-empalme">
        <i class="fas fa-handshake"></i>
        <div>
            <div>Checklist 5S – Empalme de Turno (FORMATO EN PRUEBA)</div>
        </div>
    </div>

    <p class="page-description">Marca las casillas correspondientes y añade cualquier nota relevante.</p>

    <div class="form-container-empalme">
        <form method="POST" action="{{ url_for('empalme_turno.empalme_turno_form', origen=request.args.get('origen')) }}">
            {# ================= CAMPO DE PROCESO (AHORA FIJO Y OCULTO) ================= #}
            <div class="form-question-card mb-3">
                <label class="form-label">Proceso:</label>
                <div class="form-control-static">
                    <strong id="proceso_display">{{ proceso_origen_nombre | upper }}</strong>
                </div>
                <input type="hidden" id="proceso_seleccionado" name="proceso_seleccionado" value="{{ proceso_origen_nombre | upper }}">
            </div>

            <div class="form-question-card mb-3">
                <label for="maquina_seleccionada" class="form-label">Máquina: <span class="required-asterisk">*</span></label>
                <select id="maquina_seleccionada" name="maquina_seleccionada" class="form-select" required>
                    <option value="">Selecciona una máquina</option>
                    {# Las opciones se llenarán con JavaScript #}
                </select>
            </div>

            <div class="form-question-card mb-3">
                <label for="turno" class="form-label">Turno: <span class="required-asterisk">*</span></label>
                <select class="form-select" id="turno" name="turno" required>
                    <option value="" disabled selected>Selecciona un turno</option>
                </select>
            </div>

            {# ================= CAMPO: ID que entregó máquina con validación AJAX ================= #}
            <div class="form-question-card mb-4">
                <label for="id_entrega_maquina" class="form-label">ID que entregó máquina: <span class="required-asterisk">*</span></label>
                <input type="number"
                                id="id_entrega_maquina"
                                name="id_entrega_maquina"
                                class="form-control"
                                placeholder="Ej: 12345"
                                required
                                min="1"
                                max="99999"
                                oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                maxlength="5"
                                value="{{ form_data.id_entrega_maquina | default('') }}"
                >
                <div class="form-text text-muted validation-feedback" id="id_entrega_maquina_feedback">
                    Ingresa el ID numérico de la máquina (máximo 5 dígitos).
                </div>
            </div>
            {# ================= FIN DE CAMPOS ESPECÍFICOS DEL EMPALME ================= #}

            <div class="checklist-grid">
                <div class="checklist-category">
                    <h4>1. CLASIFICAR (SEIRI)</h4>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiri_elementos_inutiles" name="seiri_elementos_inutiles" {% if form_data.seiri_elementos_inutiles %}checked{% endif %}>
                        <label for="seiri_elementos_inutiles">¿Se retiraron todos los elementos innecesarios del área de trabajo?</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiri_residuos_empaques" name="seiri_residuos_empaques" {% if form_data.seiri_residuos_empaques %}checked{% endif %}>
                        <label for="seiri_residuos_empaques">¿Se eliminaron residuos, empaques vacíos y materiales no utilizados?</label>
                    </div>
                </div>

                <div class="checklist-category">
                    <h4>2. ORDENAR (SEITON)</h4>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiton_insumos_organizados" name="seiton_insumos_organizados" {% if form_data.seiton_insumos_organizados %}checked{% endif %}>
                        <label for="seiton_insumos_organizados">¿Están todos los insumos organizados y en su lugar definido?</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiton_herramientas_ubicacion" name="seiton_herramientas_ubicacion" {% if form_data.seiton_herramientas_ubicacion %}checked{% endif %}>
                        <label for="seiton_herramientas_ubicacion">¿Herramientas o elementos compartidos están en su ubicación asignada, completos y organizados?</label>
                    </div>
                </div>

                <div class="checklist-category">
                    <h4>3. LIMPIAR (SEISO)</h4>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiso_limpieza_area" name="seiso_limpieza_area" {% if form_data.seiso_limpio_area %}checked{% endif %}>
                        <label for="seiso_limpieza_area">¿Se realizó la limpieza del área de trabajo?</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiso_libre_polvo_residuos" name="seiso_libre_polvo_residuos" {% if form_data.seiso_libre_polvo_residuos %}checked{% endif %}>
                        <label for="seiso_libre_polvo_residuos">¿Se dejó libre de polvo, residuos o derrames?</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiso_limpio_verifico_equipos" name="seiso_limpio_verifico_equipos" {% if form_data.seiso_limpio_verifico_equipos %}checked{% endif %}>
                        <label for="seiso_limpio_verifico_equipos">¿Se limpió y verificó el estado de los equipos utilizados?</label>
                    </div>
                </div>

                <div class="checklist-category">
                    <h4>4. ESTANDARIZAR (SEIKETSU)</h4>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiketsu_cumplio_rutina" name="seiketsu_cumplio_rutina" {% if form_data.seiketsu_cumplio_rutina %}checked{% endif %}>
                        <label for="seiketsu_cumplio_rutina">¿Se cumplió con la rutina de limpieza y organización establecida?</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="seiketsu_reciben_materiales" name="seiketsu_reciben_materiales" {% if form_data.seiketsu_reciben_materiales %}checked{% endif %}>
                        <label for="seiketsu_reciben_materiales">¿Se reciben materiales en áreas asignadas para almacenaje?</label>
                    </div>
                </div>

                <div class="checklist-category">
                    <h4>5. DISCIPLINA (SHITSUKE)</h4>
                    <div class="checklist-item">
                        <input type="checkbox" id="shitsuke_novedades_documentadas" name="shitsuke_novedades_documentadas" {% if form_data.shitsuke_novedades_documentadas %}checked{% endif %}>
                        <label for="shitsuke_novedades_documentadas">¿Se documentaron las novedades del turno saliente?</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="shitsuke_empalme_verbal" name="shitsuke_empalme_verbal" {% if form_data.shitsuke_empalme_verbal %}checked{% endif %}>
                        <label for="shitsuke_empalme_verbal">¿Se realizó el empalme verbal con el turno entrante?</label>
                    </div>
                </div>

                <div class="checklist-category note-section">
                    <h4>NOTA:</h4>
                    <textarea id="nota_adicional" name="nota_adicional" placeholder="Añade cualquier observación o comentario adicional.">{{ form_data.nota_adicional if form_data.nota_adicional is not none else '' }}</textarea>
                </div>
            </div>

            <button type="submit" class="btn-submit-empalme">Registrar Empalme de Turno</button>
        </form>
    </div>

    <div class="back-button-container">
        <a href="{{ url_volver_proceso or url_for('main.home') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            {% if proceso_origen_nombre %}
                Volver a Opciones de {{ proceso_origen_nombre }}
            {% else %}
                Volver
            {% endif %}
        </a>
    </div>
{% endblock %}

{% block process_page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // const procesoSelect = document.getElementById('proceso_seleccionado'); // Ya no es un select
    const procesoHiddenInput = document.getElementById('proceso_seleccionado'); // Nuevo input oculto
    const maquinaSelect = document.getElementById('maquina_seleccionada');
    const turnoSelect = document.getElementById('turno');
    const idEntregaMaquinaInput = document.getElementById('id_entrega_maquina');
    const idEntregaMaquinaFeedback = document.getElementById('id_entrega_maquina_feedback');
    const flashMessagesContainer = document.querySelector('.messages-container'); // Contenedor de los mensajes flash

     const turnosPorProceso = {
        "EXTRUSION": [
            { value: "TURNO L-J (DIURNO)", text: "TURNO L-J (DIURNO)" },
            { value: "TURNO L-J (NOCTURNO)", text: "TURNO L-J (NOCTURNO)" },
            { value: "TURNO V-D (DIURNO)", text: "TURNO V-D (DIURNO)" },
            { value: "TURNO V-D (NOCTURNO)", text: "TURNO V-D (NOCTURNO)" }
        ],
        "IMPRESION": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" },
            { value: "TURNO L-J (DIURNO)", text: "TURNO L-J (DIURNO)" },
            { value: "TURNO L-J (NOCTURNO)", text: "TURNO L-J (NOCTURNO)" },
            { value: "TURNO V-D (DIURNO)", text: "TURNO V-D (DIURNO)" },
            { value: "TURNO V-D (NOCTURNO)", text: "TURNO V-D (NOCTURNO)" }
        ],
        "CORTE": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" }
        ],
        "LAMINACION": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" },
            { value: "TURNO L-J (DIURNO)", text: "TURNO L-J (DIURNO)" },
            { value: "TURNO L-J (NOCTURNO)", text: "TURNO L-J (NOCTURNO)" },
            { value: "TURNO V-D (DIURNO)", text: "TURNO V-D (DIURNO)" },
            { value: "TURNO V-D (NOCTURNO)", text: "TURNO V-D (NOCTURNO)" }
        ],
        "SELLADO": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" }
        ],
        "INSERTADORAS": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" }
        ],
        "ADITAMENTOS": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" }
        ],
        "PROCESOS MANUALES": [
            { value: "TURNO 1 (9:30PM - 5:30AM)", text: "TURNO 1 (9:30PM - 5:30AM)" },
            { value: "TURNO 2 (5:30AM - 1:30 PM)", text: "TURNO 2 (5:30AM - 1:30 PM)" },
            { value: "TURNO 3 (1:30 PM - 9:30 PM)", text: "TURNO 3 (1:30 PM - 9:30 PM)" }
        ]
    };

    // ... Tu código de maquinasPorProceso aquí ...
    const maquinasPorProceso = {
        "EXTRUSION": ["EX05", "EX07", "EX11", "EX12", "EX13", "EX14"],
        "IMPRESION": ["FL15", "FL16", "FL18", "FL20", "FL21", "FL22"],
        "CORTE": ["RF01", "RF02", "RF03", "RF04", "RF05", "RF06", "RF07", "RF08", "RF09", "RF10", "RF11", "RF12", "RF13", "RF14", "RF15", "RF16", "RF17"],
        "LAMINACION": ["LA02", "LA03", "LA04", "LA05", "LA06"],
        "SELLADO": ["SE14", "SE15", "SE16", "SE18", "SE19", "SE20", "SE23", "SE25", "SE26", "SE30", "SE31", "SE34", "SE35", "SE38", "SE41", "SE42", "SE45", "SE46", "SE47", "SE50", "SE52", "SE55", "SE56"],
        "INSERTADORAS": [],
        "ADITAMENTOS": [],
        "PROCESOS MANUALES": []
    };
    
    // Variables para almacenar los valores seleccionados si el formulario se repobló
    const selectedMaquinaOnLoad = "{{ form_data.maquina_seleccionada | default('') }}";
    const selectedTurnoOnLoad = "{{ form_data.turno | default('') }}";

    function updateMaquinas() {
        const selectedProceso = procesoHiddenInput.value; 
        maquinaSelect.innerHTML = '<option value="">Selecciona una máquina</option>';

        if (selectedProceso && maquinasPorProceso[selectedProceso]) {
            maquinasPorProceso[selectedProceso].forEach(maquina => {
                const option = document.createElement('option');
                option.value = maquina;
                option.textContent = maquina;
                if (maquina === selectedMaquinaOnLoad) {
                    option.selected = true;
                }
                maquinaSelect.appendChild(option);
            });
        }
    }
    
    // --- FUNCIÓN PARA ACTUALIZAR LOS TURNOS ---
    function updateTurnos() {
        const selectedProceso = procesoHiddenInput.value;
        turnoSelect.innerHTML = '<option value="" disabled selected>Selecciona un turno</option>'; // Limpiar y añadir opción por defecto

        if (selectedProceso && turnosPorProceso[selectedProceso]) {
            turnosPorProceso[selectedProceso].forEach(turno => {
                const option = document.createElement('option');
                option.value = turno.value;
                option.textContent = turno.text;
                if (turno.value === selectedTurnoOnLoad) {
                    option.selected = true;
                }
                turnoSelect.appendChild(option);
            });
        }
    }

    // Ejecutar ambas funciones al cargar la página para poblar los selects con el proceso fijo
    updateMaquinas();
    updateTurnos(); // ¡Asegúrate de llamar a la nueva función!

    // ... Tu código de validación AJAX y de mensajes flash aquí ...

    let validationTimeout; // Para retrasar la validación y evitar spam de requests

    idEntregaMaquinaInput.addEventListener('input', function() {
        // Limpiar cualquier feedback anterior al empezar a escribir
        idEntregaMaquinaFeedback.textContent = 'Ingresa el ID numérico de la máquina (máximo 5 dígitos).';
        idEntregaMaquinaFeedback.className = 'form-text text-muted validation-feedback'; // Resetear clases

        clearTimeout(validationTimeout); // Limpiar el timeout anterior

        const employeeId = this.value;

        // Validar con regex simple del lado del cliente antes de enviar la petición
        const idRegex = /^[0-9]{1,5}$/;
        if (!idRegex.test(employeeId)) {
            if (employeeId.length > 0) {
                idEntregaMaquinaFeedback.textContent = 'El ID debe ser numérico y tener entre 1 y 5 dígitos.';
                idEntregaMaquinaFeedback.className = 'form-text validation-feedback text-danger';
            }
            return; // No enviar la petición si el formato es incorrecto
        }

        if (employeeId) {
            validationTimeout = setTimeout(() => {
                idEntregaMaquinaFeedback.textContent = 'Validando ID...';
                idEntregaMaquinaFeedback.className = 'form-text validation-feedback text-muted';

                fetch('/empalme_turno/validar_id_maquina', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ employee_id: employeeId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        idEntregaMaquinaFeedback.textContent = `ID válido: ${data.employee_name}`;
                        idEntregaMaquinaFeedback.className = 'form-text validation-feedback text-success';
                    } else {
                        idEntregaMaquinaFeedback.textContent = `ID inválido: ${data.message}`;
                        idEntregaMaquinaFeedback.className = 'form-text validation-feedback text-danger';
                    }
                })
                .catch(error => {
                    console.error('Error al validar ID de máquina:', error);
                    idEntregaMaquinaFeedback.textContent = 'Error al validar el ID. Intenta de nuevo.';
                    idEntregaMaquinaFeedback.className = 'form-text validation-feedback text-danger';
                });
            }, 500); // Pequeño retraso para no saturar con requests
        }
    });

    // --- JavaScript para deshabilitar el scroll en campos numéricos ---
    idEntregaMaquinaInput.addEventListener('wheel', function(e) {
        e.preventDefault();
    });

    // --- Lógica para repoblar checkboxes después de un error ---
    const form = document.querySelector('form');
    const formDataFromJinja = JSON.parse('{{ form_data | tojson | safe }}');

    if (Object.keys(formDataFromJinja).length > 0) {
        Object.keys(formDataFromJinja).forEach(key => {
            const element = form.elements[key];
            if (element && element.type === 'checkbox') {
                element.checked = !!formDataFromJinja[key]; // Convertir a booleano
            }
        });
    }

    // --- Lógica para auto-ocultar mensajes flash (copiada de home.html) ---
    const flashMessages = document.querySelectorAll('.flash-message-item');
    flashMessages.forEach(function(message, index) {
        // La animación slideInRight ya la tienen por CSS.
        // Ahora programamos su desvanecimiento y eliminación.
        setTimeout(function() {
            message.style.animation = 'fadeOutSlideLeft 0.5s ease-out forwards'; // Aplica la animación de salida
            message.addEventListener('animationend', function() {
                message.remove(); // Elimina el elemento del DOM después de la animación
            }, { once: true }); // Asegura que el listener se ejecute solo una vez
        }, 4000 + (index * 500)); // Retraso de 4 segundos + un pequeño offset por cada mensaje
    });
});
</script>
{% endblock %}