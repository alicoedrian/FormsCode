{% extends "layouts/process_base.html" %}

{# Define el título de la página #}
{% block process_title %}Registro Relación de Mezcla - {{ nombre_proceso }}{% endblock %}

{# Define el CSS específico para esta sección con mejoras de interfaz #}
{% block process_head_css %}
<style>
    /* Estilos existentes para títulos, breadcrumbs, etc. */
    .page-title-sub {
        font-size: 1.9em;
        color: #2C3E50;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        font-weight: 600;
    }
    .page-title-sub i.fa-flask {
        margin-right: 15px;
        color: #007bff;
        font-size: 1.1em;
    }
    .breadcrumb-nav {
        margin-bottom: 30px;
        font-size: 0.95em;
    }
    .breadcrumb-nav a {
        color: #007bff;
        text-decoration: none;
        transition: color 0.2s ease;
    }
    .breadcrumb-nav a:hover {
        color: #0056b3;
        text-decoration: underline;
    }
    .breadcrumb-nav .separator {
        margin: 0 10px;
        color: #adb5bd;
    }
    .breadcrumb-nav .current-page {
        color: #343a40;
        font-weight: 600;
    }

    /* ESTILOS CLAVE PARA EL CONTENEDOR Y AGRUPACIONES DEL FORMULARIO */
    .custom-form-container {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        background-color: #fff;
        padding: 35px;
        margin-bottom: 30px;
    }
    /* Estilo para las leyendas de los fieldset (agrupaciones) */
    .custom-form-container fieldset {
        border: none;
        padding: 0;
        margin-bottom: 25px;
        background-color: transparent;
        box-shadow: none;
    }
    .custom-form-container legend {
        float: none;
        width: auto;
        padding: 0 15px;
        font-size: 1.3em;
        font-weight: bold;
        color: #0056b3;
        border-bottom: none;
        margin-left: 0;
        background-color: transparent;
        border-radius: 0;
        margin-bottom: 20px;
    }

    /* --- ESTILO PARA CADA PREGUNTA INDIVIDUAL (SIMILAR A GOOGLE FORMS) --- */
    .form-question-card {
        background-color: #fff;
        border: 1px solid #dadce0;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 20px; /* Espacio entre cada pregunta */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .form-question-card:hover {
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        border-color: #c9ccd0;
    }

    /* Estilo para el asterisco de requerido */
    .form-label .required-asterisk {
        color: #dc3545;
        margin-left: 4px;
        font-weight: normal;
    }

    /* Ajustes para inputs y selects para SIMETRÍA Y UNIFORMIDAD */
    .form-label {
        font-weight: 400;
        color: #202124;
        font-size: 1em;
        margin-bottom: 12px;
        display: block;
    }
    .form-control, .form-select {
        border-radius: 4px;
        padding: 10px 12px;
        font-size: 1em;
        border: 1px solid #dadce0;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        min-height: 40px;
        box-sizing: border-box;
        background-color: #f8fafd;
    }
    .form-control:focus, .form-select:focus {
        border-color: #1a73e8;
        box-shadow: 0 0 0 1px #1a73e8;
        background-color: #fff;
    }
    .form-text { 
        font-size: 0.85em; 
        color: #5f6368; 
        margin-top: 5px; 
    }

    /* Botones */
    .btn-success {
        padding: 12px 25px;
        font-size: 1.1em;
        border-radius: 8px;
        transition: background-color 0.2s ease, transform 0.1s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-success:hover {
        background-color: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    /* Estilos para el botón de volver */
    .btn-back {
        padding: 12px 25px;
        font-size: 1.05em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    .btn-back:hover {
        background-color: #5a6268;
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }

    /* Estilos para las NOTIFICACIONES (Toast / Alerta Flotante) */
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        max-width: 350px;
    }
    .toast {
        background-color: #fff;
        border: 1px solid rgba(0,0,0,.1);
        border-radius: .25rem;
        box-shadow: 0 .25rem .75rem rgba(0,0,0,.1);
        padding: .75rem 1.25rem;
        margin-bottom: 1rem;
        transition: opacity .15s linear;
        opacity: 0;
        visibility: hidden;
        color: #212529;
    }
    .toast.show {
        opacity: 1;
        visibility: visible;
    }
    .toast-header {
        display: flex;
        align-items: center;
        padding-bottom: .25rem;
        margin-bottom: .5rem;
        border-bottom: 1px solid rgba(0,0,0,.05);
    }
    .toast-header strong {
        font-weight: 700;
    }
    .toast-body {
        font-size: .875em;
        word-wrap: break-word;
    }
    .toast.bg-success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    .toast.bg-warning { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }
    .toast.bg-danger { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    .toast .btn-close {
        padding: 0.5rem;
        margin-left: auto;
        cursor: pointer;
        background: none;
        border: none;
        font-size: 1em;
        line-height: 1;
        color: inherit;
        opacity: .5;
    }
    .toast .btn-close:hover {
        opacity: .8;
    }

</style>
{% endblock %}

{# Contenido principal de la página #}
{% block process_page_content %}
    {# Breadcrumb #}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <a href="{{ url_for('proceso_laminacion_dashboard') }}">{{ nombre_proceso }}</a>
        <span class="separator">&raquo;</span>
        <span class="current-page">{{ subseccion }}</span>
    </nav>

    {# Título y Descripción #}
    <h1 class="page-title-sub"><i class="fas fa-flask"></i> INSTRUCTIVO SE30 - SE47</h1>
    <p class="mb-5 text-secondary">Ingresar información de colaborador, máquina, y turno, así como el dato obtenido de la relación de mezcla realizada.</p>

    {# Contenedor para las notificaciones (AJAX) #}
    <div id="notification-container" class="notification-container">
        {# Las notificaciones Toast se insertarán aquí por JavaScript #}
    </div>

    {# Contenedor para tu formulario HTML personalizado #}
    <div class="custom-form-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form id="registroParametrosForm" method="POST" action="{{ url_for('proceso_laminacion_form_mezclas') }}">
            <fieldset>
                <legend>Registro de Parámetros</legend>
                <div class="row">
                    {% set campos_numericos = [
                        ('ancho', 5), ('largo', 5), ('calibre', 3), ('length_set', 5), ('speed_set', 3),
                        ('feed_rate', 5), ('skip_mode', 5), ('mark_missing_stop', 5), ('tension_adjustment', 3),
                        ('seal_time', 5), ('mark_sensing_range', 5), ('conveying_time', 3), ('velocidad', 3)
                    ] %}

                    {% for nombre, maxlength in campos_numericos %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="{{ nombre }}" class="form-label">{{ nombre.replace('_', ' ')|capitalize }}:</label>
                            <input type="text" maxlength="{{ maxlength }}" pattern="[0-9]{1,{{ maxlength }}}" inputmode="numeric" class="form-control" name="{{ nombre }}" id="{{ nombre }}" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        </div>
                    </div>
                    {% endfor %}

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="work_mode" class="form-label">Work Mode:</label>
                            <select class="form-select" id="work_mode" name="work_mode" required>
                                <option value="print stand">Print Stand</option>
                                <option value="plain">Plain</option>
                                <option value="plain stand">Plain Stand</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="cutter_set" class="form-label">Cutter Set:</label>
                            <select class="form-select" id="cutter_set" name="cutter_set" required>
                                <option value="enable">Enable</option>
                                <option value="disable">Disable</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="cliente" class="form-label">Cliente:</label>
                            <input type="text" maxlength="12" class="form-control" name="cliente" id="cliente" pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]{1,12}$" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="parte" class="form-label">Parte:</label>
                            <input type="text" maxlength="7" class="form-control" name="parte" id="parte" pattern="^[A-Za-z0-9]{1,7}$" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="material" class="form-label">Material:</label>
                            <input type="text" maxlength="12" class="form-control" name="material" id="material" pattern="^[A-Za-z0-9]{1,12}$" required>
                        </div>
                    </div>
                    <!-- Selladores Transversales -->
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="selladores_transversales" class="form-label">Selladores Transversales (Cantidad):</label>
                            <input type="text" maxlength="2" pattern="[0-9]{1,2}" inputmode="numeric"
                                class="form-control" name="selladores_transversales" id="selladores_transversales" required
                                oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        </div>
                    </div>

                    <!-- Selladores Longitudinales -->
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="selladores_longitudinales" class="form-label">Selladores Longitudinales (Cantidad):</label>
                            <input type="text" maxlength="2" pattern="[0-9]{1,2}" inputmode="numeric"
                                class="form-control" name="selladores_longitudinales" id="selladores_longitudinales" required
                                oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        </div>
                    </div>

                    <!-- Fotocelda con opción editable -->
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fotocelda" class="form-label">Fotocelda:</label>
                            <select class="form-select" id="fotocelda" name="fotocelda" required onchange="mostrarInputFotocelda(this)">
                                <option value="">Seleccione...</option>
                                <option value="N/A">N/A</option>
                                <option value="otro">Otro (especifique)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Campo oculto que se muestra solo si elige "otro" -->
                    <div class="col-md-6" id="fotocelda_otro_container" style="display: none;">
                        <div class="form-question-card">
                            <label for="fotocelda_otro" class="form-label">Especificar Fotocelda:</label>
                            <input type="text" class="form-control" id="fotocelda_otro" name="fotocelda_otro" maxlength="50">
                        </div>
                    </div>

                    <!-- Cortasolapa -->
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="cortasolapa" class="form-label">Cortasolapa:</label>
                            <select class="form-select" id="cortasolapa" name="cortasolapa" required>
                                <option value="X1">X1</option>
                                <option value="X2">X2</option>
                                <option value="X3">X3</option>
                                <option value="X4">X4</option>
                                <option value="X5">X5</option>
                            </select>
                        </div>
                    </div>

                    <!-- Formato -->
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="formato" class="form-label">Formato:</label>
                            <select class="form-select" id="formato" name="formato" required>
                                <option value="Doble">Doble</option>
                                <option value="Triple">Triple</option>
                                <option value="Cuádruple">Cuádruple</option>
                                <option value="Quíntuple">Quíntuple</option>
                                <option value="Sextuple">Sextuple</option>
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Temperaturas por Módulo</legend>
                <div class="row">
                    {% for i in range(1, 13) %}
                    <div class="col-md-3">
                        <div class="form-question-card">
                            <label for="modulo_{{ i }}" class="form-label">Módulo {{ i }}:</label>
                            <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="modulo_{{ i }}" id="modulo_{{ i }}" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </fieldset>

            <button type="submit" class="btn btn-success me-2">Enviar Registro</button>
        </form>
    </div>

    {# Botón de Volver #}
    <div class="back-button-container">
        <a href="{{ url_volver or url_for('proceso_laminacion_dashboard') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Volver a Opciones de Laminación
        </a>
    </div>
{% endblock %}

{# Script JavaScript para manejar submission AJAX y truncar decimales en tiempo real #}
{% block process_page_scripts %}
<script>
    function mostrarInputFotocelda(select) {
        const otroInput = document.getElementById('fotocelda_otro_container');
        const otroCampo = document.getElementById('fotocelda_otro');

        if (select.value === 'otro') {
            otroInput.style.display = 'block';
            otroCampo.required = true;
        } else {
            otroInput.style.display = 'none';
            otroCampo.value = '';
            otroCampo.required = false;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Script de formulario de relación de mezclas cargado.");

        const form = document.getElementById('relacionMezclasForm');
        const notificationContainer = document.getElementById('notification-container');
        const pesoAdhesivoInput = document.getElementById('peso_adhesivo');
        const pesoCorreactanteInput = document.getElementById('peso_correactante');
        const relacionMezclaInput = document.getElementById('relacion_mezcla');

        // --- Funciones para manejar Notificaciones (Toasts) ---
        function showNotification(message, category = 'info', delay = 5000) {
            const toast = document.createElement('div');
            // Clases de Bootstrap para Toasts y colores
            toast.className = `toast align-items-center text-white bg-${category} border-0 show`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            // Ajustar el color del texto para que sea legible en los fondos de Bootstrap
            let textColorClass = 'text-white'; 
            if (category === 'warning' || category === 'success' || category === 'info') {
                textColorClass = 'text-dark'; // Texto oscuro para fondos claros
            }

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body ${textColorClass}">
                        ${message}
                    </div>
                    <button type="button" class="btn-close ${textColorClass} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            notificationContainer.append(toast);

            // Eliminar el toast después de un tiempo
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, delay);
        }

        // --- Lógica de Truncamiento y Validación de Decimales en Tiempo Real (para type="text") ---
        const setupDecimalInput = (inputElement) => {
            if (!inputElement) return; // Asegura que el elemento existe

            // Listener para 'input' (mientras el usuario escribe)
            inputElement.addEventListener('input', function(event) {
                let value = event.target.value;
                let cursorPosition = event.target.selectionStart;

                // 1. Reemplaza comas por puntos
                value = value.replace(',', '.'); 
                
                // 2. Filtra caracteres no numéricos y maneja la estructura
                let currentVal = value;
                
                // Eliminar cualquier cosa que no sea dígito, punto o guion
                currentVal = currentVal.replace(/[^0-9.-]/g, '');

                // Asegurar que el guion esté solo al principio
                if (currentVal.startsWith('-') && currentVal.indexOf('-', 1) !== -1) {
                    currentVal = '-' + currentVal.substring(1).replace(/-/g, '');
                } else if (!currentVal.startsWith('-') && currentVal.includes('-')) {
                    currentVal = currentVal.replace(/-/g, '');
                }

                // Asegurar que solo haya un punto decimal
                const parts = currentVal.split('.');
                if (parts.length > 2) {
                    currentVal = parts[0] + '.' + parts.slice(1).join('');
                }
                
                // Truncar a 2 decimales si el punto ya existe y hay más de 2 decimales
                if (currentVal.includes('.')) {
                    const decimalPart = currentVal.split('.')[1];
                    if (decimalPart.length > 2) {
                        currentVal = currentVal.substring(0, currentVal.indexOf('.') + 3);
                    }
                }

                // Limpiar ceros iniciales (ej. 012 -> 12, 00.5 -> 0.5)
                if (currentVal.length > 1 && currentVal.startsWith('0') && currentVal[1] !== '.') {
                     currentVal = currentVal.substring(1);
                }
                
                // Asegurar que no sea negativo si min="0" (validación visual)
                if (inputElement.min === '0' && parseFloat(currentVal) < 0 && currentVal !== '-') {
                    currentVal = ''; 
                }


                // Actualizar el valor del input solo si ha cambiado
                if (event.target.value !== currentVal) {
                    event.target.value = currentVal;
                    // Reajustar la posición del cursor
                    event.target.setSelectionRange(cursorPosition, cursorPosition);
                }
                
                // Llama a la función de cálculo de relación después de la manipulación del input
                checkRelationMixtureAlert();
            });

            // Listener para 'change' (cuando el campo pierde el foco) para formatear a 2 decimales finales
            inputElement.addEventListener('change', function(event) {
                let value = event.target.value;
                if (typeof value === 'string') {
                    value = value.replace(',', '.');
                }
                let floatValue = parseFloat(value);

                if (!isNaN(floatValue)) {
                    inputElement.value = floatValue.toFixed(2);
                    if (inputElement.min === '0' && floatValue < 0) {
                        inputElement.value = '0.00';
                    }
                } else if (value !== '' && value !== '-' && value !== '.') {
                    inputElement.value = '';
                }
                checkRelationMixtureAlert();
            });

            // Inicializar el valor al cargar la página si hay un valor preexistente
            if (inputElement.value !== '') {
                let initialValue = inputElement.value.replace(',', '.');
                if (!isNaN(parseFloat(initialValue))) {
                    inputElement.value = parseFloat(initialValue).toFixed(2);
                } else {
                    inputElement.value = '';
                }
            }
        };

        // Aplica la configuración de entrada decimal a los campos relevantes
        setupDecimalInput(pesoAdhesivoInput);
        setupDecimalInput(pesoCorreactanteInput);
        // NO aplicar setupDecimalInput a relacionMezclaInput porque es un campo de salida/resultado visual

        // --- Lógica del Cálculo de Relación y Alerta en Frontend ---
        function checkRelationMixtureAlert() {
            const pesoAdhesivoVal = pesoAdhesivoInput.value.replace(',', '.');
            const pesoCorreactanteVal = pesoCorreactanteInput.value.replace(',', '.');

            const pesoAdhesivo = parseFloat(pesoAdhesivoVal);
            const pesoCorreactante = parseFloat(pesoCorreactanteVal);
            
            // Remover alertas de cuidado previas para no duplicarlas
            const existingWarningToasts = notificationContainer.querySelectorAll('.toast.bg-warning');
            existingWarningToasts.forEach(toast => toast.remove());

            if (isNaN(pesoAdhesivo) || isNaN(pesoCorreactante) || pesoAdhesivoVal === '' || pesoCorreactanteVal === '') {
                // No podemos calcular si los valores no son números o están vacíos
                return;
            }

            if (pesoCorreactante === 0) {
                showNotification('El peso correactante no puede ser cero para calcular la relación.', 'warning', 7000);
                return; 
            }

            const relacionCalculada = pesoAdhesivo / pesoCorreactante;
            const relacionCalculadaRedondeada = Math.round(relacionCalculada * 100) / 100; // Redondeamos a 2 decimales para la comparación

            // Actualizar el campo de Relación de Mezcla visualmente
            if (!isNaN(relacionCalculadaRedondeada)) {
                relacionMezclaInput.value = relacionCalculadaRedondeada.toFixed(2);
            } else {
                relacionMezclaInput.value = '';
            }


            if (relacionCalculadaRedondeada >= 1.23 && relacionCalculadaRedondeada <= 1.32) {
                showNotification('TENER CUIDADO CON LA RELACIÓN DE MEZCLAS', 'warning', 10000); // 10 segundos para verla
            }
        }


        // --- Manejo del Envío del Formulario (AJAX) ---
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevenir el envío tradicional del formulario

            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');

            // Deshabilitar botón y mostrar spinner
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...`;

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log("Respuesta del servidor:", result);

                // Mostrar la notificación del resultado de la submission
                showNotification(result.message, result.category || 'info');
                
                // Si la submission fue exitosa (el backend aceptó los datos)
                if (result.success) {
                    form.reset(); // Limpia el formulario
                    // También resetear los valores val de los select para que se reestablezcan a la opción por defecto
                    document.getElementById('maquina').value = "";
                    document.getElementById('turno').value = "";
                    document.getElementById('operario_responsable').value = "";

                    // Redirigir siempre después de un éxito
                    setTimeout(() => {
                        window.location.href = result.redirect_url || "{{ url_for('proceso_laminacion_dashboard') }}";
                    }, 2500); // Redirige después de 2.5 segundos
                } else {
                    // Si success es false (error de validación crítica del backend o de Sheets)
                    // No limpiamos el formulario para que el usuario vea sus errores
                }
            } catch (error) {
                console.error('Error en la solicitud AJAX:', error);
                showNotification('Hubo un problema de conexión. Intenta de nuevo.', 'danger');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Enviar Registro'; // Restaurar texto del botón
            }
        });

        // Llamar a checkRelationMixtureAlert al cargar la página y cuando los campos relevantes cambian
        checkRelationMixtureAlert(); // Para valores iniciales al cargar
        // checkRelationMixtureAlert ya se llama en cada 'input' event en setupDecimalInput
        // pero podemos asegurarnos de que se llama si los valores cambian por otras vías
        // (por ejemplo, autocompletado del navegador, aunque el 'input' suele cubrirlo)
        // Por ahora, los listeners en setupDecimalInput son suficientes.
    });
</script>
{% endblock %}   