{% extends "layouts/process_base.html" %}

{# Define el título de la página #}
{% block process_title %}SE34 – {{ nombre_proceso }}{% endblock %}

{# Define el CSS específico para esta sección con mejoras de interfaz #}
{% block process_head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/css4.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/se30_se47_form_styles.css') }}">
{% endblock %}

{# Contenido principal de la página #}
{% block process_page_content %}
    {# Breadcrumb - Ajustado para apuntar correctamente al blueprint de sellado #}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <a href="{{ url_for('sellado.proceso_sellado_dashboard') }}">
            <i class="fas fa-home" style="margin-right: 0.25rem;"></i> {# Añadido icono de home #}
            Inicio
        </a>
        <span class="separator">›</span> {# Cambiado de &raquo; #}
        <a href="{{ url_for('sellado.proceso_sellado_dashboard') }}">{{ nombre_proceso }}</a>
        <span class="separator">›</span> {# Cambiado de &raquo; #}
        <span class="current-page">{{ subseccion }}</span>
    </nav>
    
    {# Título y Descripción #}
        <div class="page-title-se34"> {# Clase actualizada #}
            <i class="fas fa-cog"></i> {# Icono actualizado para parámetros #}
            <div>
                <div>{{ subseccion }}</div>
            </div>
        </div>
        <p class="page-description">Ingrese los parámetros de operación para las máquinas SE34.</p> {# Texto de descripción actualizado #}


    {# Contenedor para las notificaciones (AJAX) #}
    <div id="notification-container" class="notification-container">
        {# Las notificaciones Toast se insertarán aquí por JavaScript #}
    </div>

    {# Contenedor para tu formulario HTML personalizado #}
    <div class="custom-form-container">
        {# Mostrar mensajes flash de Flask (si se usan para errores no-AJAX o redirecciones) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {# Formulario HTML - Action ajustado para apuntar al blueprint 'se34' #}
        <form id="registroParametrosForm" method="POST" action="{{ url_for('se34.sellado_form_se34') }}">
            <fieldset>
                <legend>Registro de Parámetros</legend>
                <div class="row">

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fecha" class="form-label">Fecha:</label>
                            {# El campo de fecha es de solo lectura y se carga con el valor del backend #}
                            <input type="text" class="form-control" name="fecha" id="fecha" value="{{ fecha_actual }}" readonly>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="id_empleado" class="form-label">ID Empleado:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="5" class="form-control" id="id_empleado" name="id_empleado"
                                oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                onchange="consultarEmpleadoPorID()" 
                                value="{{ form_data.id_empleado if form_data.id_empleado is not none else '' }}" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="nombre_empleado" class="form-label">Nombre Empleado:</label>
                            <input type="text" class="form-control" id="nombre_empleado" name="nombre_empleado" 
                                value="{{ form_data.nombre_empleado if form_data.nombre_empleado is not none else '' }}" readonly>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="trabajo" class="form-label">Trabajo:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="8" pattern="^[A-Za-z0-9]{1,8}$"
                                class="form-control" id="trabajo" name="trabajo"
                                oninput="this.value=this.value.replace(/[^A-Za-z0-9]/g,'');"
                                onchange="consultarDatosTrabajo()" 
                                value="{{ form_data.trabajo if form_data.trabajo is not none else '' }}" required>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="parte" class="form-label">Parte:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="7" class="form-control" name="parte" id="parte" readonly 
                                value="{{ form_data.parte if form_data.parte is not none else '' }}" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="cliente" class="form-label">Cliente:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="12" class="form-control" name="cliente" id="cliente" 
                                value="{{ form_data.cliente if form_data.cliente is not none else '' }}" required>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="estructura" class="form-label">Estructura:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="12" class="form-control" name="estructura" id="estructura" readonly 
                                value="{{ form_data.estructura if form_data.estructura is not none else '' }}" required>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="ancho" class="form-label">Ancho:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="20" class="form-control" name="ancho" id="ancho" readonly 
                                value="{{ form_data.ancho if form_data.ancho is not none else '' }}" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="largo" class="form-label">Largo:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="20" class="form-control" name="largo" id="largo" readonly 
                                value="{{ form_data.largo if form_data.largo is not none else '' }}" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fuelle" class="form-label">Fuelle:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="20" class="form-control" name="fuelle" id="fuelle" readonly 
                                value="{{ form_data.fuelle if form_data.fuelle is not none else '' }}" required>
                        </div>
                    </div>    

                    {# Los campos numéricos que se repiten con un bucle #}
                    {% set campos_numericos = [
                        ('calibre', 'Calibre', 3), 
                        ('velocidad', 'Velocidad', 3),
                        ('seal_set', 'Seal Set', 5),
                        ('speed_set', 'Speed Set', 3),
                        ('feed_rate', 'Feed Rate', 5),
                        ('tension_adjustment', 'Tension Adjustment', 3)                        
                    ] %}

                    {% for nombre_campo, label_campo, maxlength in campos_numericos %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="{{ nombre_campo }}" class="form-label">{{ label_campo }}:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="{{ maxlength }}" pattern="[0-9.,]{1,{{ maxlength }}}" inputmode="numeric" 
                                class="form-control" name="{{ nombre_campo }}" id="{{ nombre_campo }}" required 
                                oninput="this.value=this.value.replace(/[^0-9.,]/g,'');"
                                value="{{ form_data[nombre_campo] if form_data[nombre_campo] is not none else '' }}">
                        </div>
                    </div>
                    {% endfor %}

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="tipo_bolsa" class="form-label">Tipo de Bolsa:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="tipo_bolsa" name="tipo_bolsa" required>
                                <option value="">Seleccionar</option>
                                <option value="rollo_arr_abj" {% if form_data.tipo_bolsa == 'rollo_arr_abj' %}selected{% endif %}>Rollo Arriba Rollo Abajo</option>
                                <option value="plana" {% if form_data.tipo_bolsa == 'plana' %}selected{% endif %}>Plana</option>
                                <option value="plana_zipp" {% if form_data.tipo_bolsa == 'plana_zipp' %}selected{% endif %}>Plana con Zipper</option>
                                <option value="flowpack" {% if form_data.tipo_bolsa == 'flowpack' %}selected{% endif %}>Flow Pack</option>
                                <option value="flex_up" {% if form_data.tipo_bolsa == 'flex_up' %}selected{% endif %}>Flex Up</option>
                                <option value="flex_up_zipp" {% if form_data.tipo_bolsa == 'flex_up_zipp' %}selected{% endif %}>Flex Up con Zipper</option>
                                <option value="manga" {% if form_data.tipo_bolsa == 'manga' %}selected{% endif %}>Manga Pastelera</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="abre_boca" class="form-label">Abre Boca:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="abre_boca" name="abre_boca" required>
                                <option value="">Seleccionar</option>
                                <option value="si" {% if form_data.abre_boca == 'si' %}selected{% endif %}>SI</option>
                                <option value="no" {% if form_data.abre_boca == 'no' %}selected{% endif %}>NO</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="cara" class="form-label">Cara:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="cara" name="cara" required>
                                <option value="">Seleccionar</option>
                                <option value="1" {% if form_data.cara == '1' %}selected{% endif %}>1</option>
                                <option value="2" {% if form_data.cara == '2' %}selected{% endif %}>2</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fotocelda" class="form-label">Fotocelda:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="fotocelda" name="fotocelda" onchange="manejarFotocelda()" required>
                                <option value="">Seleccionar</option>
                                <option value="si" {% if form_data.fotocelda == 'si' %}selected{% endif %}>SI</option>
                                <option value="no" {% if form_data.fotocelda == 'no' %}selected{% endif %}>NO</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6 d-none" id="grupo_num_fotoceldas">
                        <div class="form-question-card">
                            <label for="num_fotoceldas" class="form-label">Número de Fotoceldas:</label>
                            <select class="form-select" id="num_fotoceldas" name="num_fotoceldas" onchange="mostrarDescripciones()">
                                <option value="">Seleccionar</option>
                                <option value="2" {% if form_data.num_fotoceldas == '2' %}selected{% endif %}>2</option>
                                <option value="3" {% if form_data.num_fotoceldas == '3' %}selected{% endif %}>3</option>
                            </select>
                        </div>
                    </div>

                    <!-- Descripciones dinámicas -->
                    <div class="col-md-6 d-none" id="desc_foto_1">
                        <div class="form-question-card">
                            <label for="desc_foto_1" class="form-label">Descripción Fotocelda 1:</label>
                            <input type="text" maxlength="300" class="form-control" name="desc_foto_1" id="desc_foto_1" placeholder="Describir ubicación y posicionamiento"
                            value="{{ form_data.desc_foto_1 if form_data.desc_foto_1 is not none else '' }}">
                        </div>
                    </div>

                    <div class="col-md-6 d-none" id="desc_foto_2">
                        <div class="form-question-card">
                            <label for="desc_foto_2" class="form-label">Descripción Fotocelda 2:</label>
                            <input type="text" maxlength="300" class="form-control" name="desc_foto_2" id="desc_foto_2" placeholder="Describir ubicación y posicionamiento"
                            value="{{ form_data.desc_foto_2 if form_data.desc_foto_2 is not none else '' }}">
                        </div>
                    </div>

                    <div class="col-md-6 d-none" id="desc_foto_3">
                        <div class="form-question-card">
                            <label for="desc_foto_3" class="form-label">Descripción Fotocelda 3:</label>
                            <input type="text" maxlength="300" class="form-control" name="desc_foto_3" id="desc_foto_3" placeholder="Describir ubicación y posicionamiento"
                            value="{{ form_data.desc_foto_3 if form_data.desc_foto_3 is not none else '' }}">
                        </div>
                    </div>


                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="work_mode" class="form-label">Work Mode:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="work_mode" name="work_mode" required>
                                <option value="">Seleccionar</option>
                                <option value="print stand" {% if form_data.work_mode == 'print stand' %}selected{% endif %}>Print Stand</option>
                                <option value="plain" {% if form_data.work_mode == 'plain' %}selected{% endif %}>Plain</option>
                                <option value="plain stand" {% if form_data.work_mode == 'plain stand' %}selected{% endif %}>Plain Stand</option>
                                <option value="print" {% if form_data.work_mode == 'print' %}selected{% endif %}>Print</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="color_sensor_fotoc" class="form-label">Color Sensor Fotocelda:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="color_sensor_fotoc" name="color_sensor_fotoc" required>
                                <option value="">Seleccionar</option>
                                <option value="verde" {% if form_data.color_sensor_fotoc == 'verde' %}selected{% endif %}>Verde</option>
                                <option value="rojo" {% if form_data.color_sensor_fotoc == 'rojo' %}selected{% endif %}>Rojo</option>
                                <option value="azul" {% if form_data.color_sensor_fotoc == 'azul' %}selected{% endif %}>Azúl</option>
                                <option value="noaplica" {% if form_data.color_sensor_fotoc == 'noaplica' %}selected{% endif %}>N/A (Sin Impresión)</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="doble_corte" class="form-label"> (Cutter Mode) Doble corte:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="doble_corte" name="doble_corte" required>
                                <option value="">Seleccionar</option>
                                <option value="si" {% if form_data.doble_corte == 'si' %}selected{% endif %}>SI</option>
                                <option value="no" {% if form_data.doble_corte == 'no' %}selected{% endif %}>NO</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="medida_doblecor" class="form-label">(Cutter Offset) Medida del doble corte:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="4" pattern="[0-9]{1,2}" inputmode="numeric"
                                class="form-control" name="medida_doblecor" id="medida_doblecor" required
                                oninput="this.value=this.value.replace(/[^0-9.,]/g,'');" placeholder="Si no lleva doble corte ingresar 0"
                                value="{{ form_data.medida_doblecor if form_data.medida_doblecor is not none else '' }}">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="zipper" class="form-label"> Zipper <span class="required-asterisk">*</span></label>
                            <select class="form-select" id="zipper" name="zipper" required>
                                <option value="">Seleccionar</option>
                                <option value="enable" {% if form_data.zipper == 'enable' %}selected{% endif %}>Enable</option>
                                <option value="disable" {% if form_data.zipper == 'disable' %}selected{% endif %}>Disable</option>
                            </select>
                        </div>
                    </div>

                    <fieldset>
                        <legend>Ubicación de aditamentos y módulos (En pedidos complejos)</legend>

                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="pedido_critico" class="form-label">¿Es un pedido crítico?<span class="required-asterisk">*</span></label>
                                <select class="form-select" id="pedido_critico" name="pedido_critico" onchange="manejarPedidoCritico()" required>
                                    <option value="">Seleccionar</option>
                                    <option value="si" {% if form_data.pedido_critico == 'si' %}selected{% endif %}>SI</option>
                                    <option value="no" {% if form_data.pedido_critico == 'no' %}selected{% endif %}>NO</option>
                                </select>
                            </div>
                        </div>

                        <div id="campos_aditamentos" class="row d-none">
                            <div class="col-md-6">
                                <div class="form-question-card">
                                    <label for="ubicacion_modulo_1" class="form-label">Ubicación Aditamentos Módulo 1:</label>
                                    <input type="text" maxlength="100" class="form-control" name="ubicacion_modulo_1" rows="3" id="ubicacion_modulo_1" placeholder="Describir posición y ubicación"
                                    value="{{ form_data.ubicacion_modulo_1 if form_data.ubicacion_modulo_1 is not none else '' }}">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-question-card">
                                    <label for="ubicacion_modulo_2" class="form-label">Ubicación Aditamentos Módulo 2:</label>
                                    <input type="text" maxlength="100" class="form-control" name="ubicacion_modulo_2" rows="3" id="ubicacion_modulo_2" placeholder="Describir posición y ubicación"
                                    value="{{ form_data.ubicacion_modulo_2 if form_data.ubicacion_modulo_2 is not none else '' }}">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-question-card">
                                    <label for="ubicacion_modulo_3" class="form-label">Ubicación Aditamentos Módulo 3:</label>
                                    <input type="text" maxlength="100" class="form-control" name="ubicacion_modulo_3" rows="3" id="ubicacion_modulo_3" placeholder="Describir posición y ubicación"
                                    value="{{ form_data.ubicacion_modulo_3 if form_data.ubicacion_modulo_3 is not none else '' }}">
                                </div>
                            </div>
                        </div>
                    </fieldset>               
                </div>
            </fieldset>


            <fieldset>
                <legend>Temperaturas por Módulo</legend>
                <div class="row">
                    {% for i in range(1, 23) %}
                    <div class="col-md-3">
                        <div class="form-question-card">
                            <label for="modulo_{{ i }}" class="form-label">Módulo {{ i }}:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" 
                                class="form-control" name="modulo_{{ i }}" id="modulo_{{ i }}" required 
                                oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                value="{{ form_data['modulo_' + i|string] if form_data['modulo_' + i|string] is not none else '' }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </fieldset>

            <fieldset>
                <legend>Observaciones</legend>
                <div class="row">
                    <div class="col-12">
                        <div class="form-question-card">
                            <label for="observaciones" class="form-label">Notas / Observaciones:</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="4" maxlength="500"
                                placeholder="Escriba aquí cualquier comentario o novedad relevante..."></textarea>
                        </div>
                    </div>
                </div>
            </fieldset>

            <button type="submit" class="btn btn-success me-2">Enviar Registro</button>
        </form>
    </div>

    {# Botón de Volver #}
    <div class="back-button-container">
        {# La URL para volver debe apuntar al dashboard de sellado, no al de laminación #}
        <a href="{{ url_volver or url_for('sellado.proceso_sellado_dashboard') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Volver a Sellado
        </a>
    </div>
{% endblock %}

{# Script JavaScript para manejar submission AJAX y autocompletado #}
{% block process_page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('registroParametrosForm');
        const notify = document.getElementById('notification-container');
        if (!form || !notify) return;

        // --- Funciones auxiliares globales para ser accesibles desde onchange/onload ---
        window.mostrarInputFotocelda = function(selectElement) { 
            const container = document.getElementById('fotocelda_otro_container');
            const input = document.getElementById('fotocelda_otro');
            if (!container || !input) return; 
            if (selectElement.value === 'otro') {
                container.style.display = 'block';
                input.required = true;
            } else {
                container.style.display = 'none';
                input.value = '';
                input.required = false;
            }
        };

        window.consultarDatosTrabajo = async function() {
            const trabajoInput = document.getElementById("trabajo");
            const trabajo = trabajoInput.value;
            const parteInput = document.getElementById("parte");
            const estructuraInput = document.getElementById("estructura");
            const clienteInput = document.getElementById("cliente");
            const anchoInput = document.getElementById("ancho");
            const largoInput = document.getElementById("largo");
            const fuelleInput = document.getElementById("fuelle");
            if (!trabajo) {
                parteInput.value = "";
                estructuraInput.value = "";
                clienteInput.value = "";
                clienteInput.removeAttribute("readonly");
                anchoInput.value = "";
                largoInput.value = "";
                fuelleInput.value = "";
                return;
            }
            try {
                const response = await fetch(`/sellado/se34/api/trabajo/${trabajo}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Error desconocido al consultar trabajo.");
                parteInput.value = data.parte || "";
                estructuraInput.value = data.estructura || "";
                if (data.cliente && data.cliente.trim() !== "") {
                    clienteInput.value = data.cliente;
                    clienteInput.setAttribute("readonly", "true"); 
                } else {
                    clienteInput.value = "";
                    clienteInput.removeAttribute("readonly");
                }
                anchoInput.value = data.ancho ? parseFloat(data.ancho).toFixed(2) : "";
                largoInput.value = data.largo ? parseFloat(data.largo).toFixed(2) : "";
                fuelleInput.value = data.fuelle ? parseFloat(data.fuelle).toFixed(2) : "";
            } catch (error) {
                console.error("Error al consultar el trabajo:", error);
                alert(`Error al consultar el trabajo: ${error.message || 'No se encontró el trabajo o hubo un problema de conexión.'}`);
                parteInput.value = "";
                estructuraInput.value = "";
                clienteInput.value = "";
                clienteInput.removeAttribute("readonly");
                anchoInput.value = "";
                largoInput.value = "";
                fuelleInput.value = "";
            }
        };

        window.consultarEmpleadoPorID = async function() {
            const idInput = document.getElementById("id_empleado");
            const id = idInput.value;
            const nombreEmpleadoInput = document.getElementById("nombre_empleado");
            if (!id) {
                nombreEmpleadoInput.value = "";
                return;
            }
            try {
                const response = await fetch(`/sellado/se34/api/empleado?id=${id}`);
                const data = await response.json();
                if (data && data.success) {
                    nombreEmpleadoInput.value = data.nombre || 'No encontrado';
                } else {
                    nombreEmpleadoInput.value = data.nombre || 'No encontrado'; 
                }
            } catch (error) {
                console.error("Error al consultar el empleado:", error);
                nombreEmpleadoInput.value = "Error en la consulta";
            }
        };

        // === NOTIFICACIÓN AJUSTADA PARA SCROLL AL TOPE ===
        function showNotification(response) {
            notify.innerHTML = ''; 
            const toast = document.createElement('div');
            toast.className = `alert alert-${response.category} alert-dismissible fade show`;
            toast.setAttribute('role', 'alert');
            let icon = '';
            if (response.category === 'success') {
                icon = '<i class="fas fa-check-circle me-2"></i>';
            } else if (response.category === 'danger') {
                icon = '<i class="fas fa-exclamation-circle me-2"></i>';
            } else {
                icon = '<i class="fas fa-info-circle me-2"></i>';
            }
            let messageDetails = '';
            if (response.details) { 
                messageDetails = `<div class="small mt-1">${response.details}</div>`;
            }
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    ${icon}
                    <div>
                        <strong>${response.message}</strong>
                        ${messageDetails}
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            notify.appendChild(toast);

            // === SCROLL AUTOMÁTICO AL TOPE ===
            setTimeout(function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);

            // Auto-ocultar notificaciones de éxito o advertencia después de 8 segundos
            if (['success','warning'].includes(response.category)) {
                setTimeout(() => {
                    const bootstrapAlert = new bootstrap.Alert(toast);
                    bootstrapAlert.close();
                }, 8000);
            }
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            const btn = form.querySelector('button[type="submit"]');
            const origText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" aria-hidden="true"></span> Enviando...`;

            const payload = {};
            new FormData(form).forEach((value, key) => {
                payload[key] = value;
            });
            const fotoceldaValue = payload['fotocelda'];
            const fotoceldaOtroValue = payload['fotocelda_otro'];
            if (fotoceldaValue !== 'otro') {
                payload['fotocelda_otro'] = null; 
            } else if (fotoceldaOtroValue === undefined || fotoceldaOtroValue.trim() === "") {
                payload['fotocelda_otro'] = null;
            }

            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                showNotification(result);
                if (res.ok && result.success) {
                    form.reset();
                    form.querySelectorAll('select').forEach(s => {
                        if (s.options.length > 0) {
                            s.selectedIndex = 0; 
                        }
                    });
                    mostrarInputFotocelda(document.getElementById('fotocelda'));
                    document.getElementById('nombre_empleado').value = "";
                    document.getElementById('parte').value = "";
                    document.getElementById('cliente').value = "";
                    document.getElementById('cliente').removeAttribute('readonly');
                    document.getElementById('estructura').value = "";
                    document.getElementById('ancho').value = "";
                    document.getElementById('largo').value = "";
                    document.getElementById('fuelle').value = "";
                } else {
                    if (result.form_data) {
                        for (const key in result.form_data) {
                            const input = document.getElementById(key);
                            if (input) {
                                if (input.tagName === 'SELECT') {
                                    input.value = result.form_data[key];
                                    if (key === 'fotocelda') {
                                        mostrarInputFotocelda(input);
                                    }
                                } else {
                                    input.value = result.form_data[key];
                                }
                            }
                        }
                        const trabajoInput = document.getElementById('trabajo');
                        if (trabajoInput.value) { 
                            await consultarDatosTrabajo(); 
                        }
                        const empleadoIdInput = document.getElementById('id_empleado');
                        if (empleadoIdInput.value) { 
                            await consultarEmpleadoPorID();
                        }
                    }
                }
            } catch (err) {
                console.error('AJAX error:', err);
                showNotification({
                    category: 'danger',
                    message: 'Error de red o servidor.',
                    details: 'Por favor, verifica tu conexión a internet e inténtalo de nuevo.'
                });
            } finally {
                btn.disabled = false;
                btn.innerHTML = origText;
            }
        });

        form.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT' && e.target.type !== 'submit') {
                e.preventDefault();
            }
        });

        document.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
            input.addEventListener('wheel', e => e.preventDefault());
        });

        const idEmpleadoInput = document.getElementById('id_empleado');
        const trabajoInput = document.getElementById('trabajo');
        const fotoceldaSelect = document.getElementById('fotocelda');
        if (idEmpleadoInput.value) {
            consultarEmpleadoPorID();
        }
        if (trabajoInput.value) {
            consultarDatosTrabajo();
        }
        mostrarInputFotocelda(fotoceldaSelect)

    });

    function manejarFotocelda() {
        const valor = document.getElementById("fotocelda").value;
        const grupoNum = document.getElementById("grupo_num_fotoceldas");

        // Ocultar descripciones siempre al cambiar fotocelda
        ocultarDescripciones();

        if (valor === "si") {
            grupoNum.classList.remove("d-none");
        } else {
            grupoNum.classList.add("d-none");
        }
    }

    function mostrarDescripciones() {
        ocultarDescripciones();
        const cantidad = document.getElementById("num_fotoceldas").value;

        if (cantidad >= 1) document.getElementById("desc_foto_1").classList.remove("d-none");
        if (cantidad >= 2) document.getElementById("desc_foto_2").classList.remove("d-none");
        if (cantidad == 3) document.getElementById("desc_foto_3").classList.remove("d-none");
    }

    function ocultarDescripciones() {
        document.getElementById("desc_foto_1").classList.add("d-none");
        document.getElementById("desc_foto_2").classList.add("d-none");
        document.getElementById("desc_foto_3").classList.add("d-none");
    }

    function manejarPedidoCritico() {
        const seleccion = document.getElementById("pedido_critico").value;
        const campos = document.getElementById("campos_aditamentos");

        if (seleccion === "si") {
            campos.classList.remove("d-none");
        } else {
            campos.classList.add("d-none");

            // Limpiar valores si se oculta
            document.getElementById("ubicacion_modulo_1").value = "";
            document.getElementById("ubicacion_modulo_2").value = "";
            document.getElementById("ubicacion_modulo_3").value = "";
        }
    }
</script>
{% endblock %}
