{% extends "layouts/process_base.html" %}

{# Define el título de la página #}
{% block process_title %}SE50 - {{ nombre_proceso }}{% endblock %}

{# Define el CSS específico para esta sección con mejoras de interfaz #}
{% block process_head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/css4.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/se30_se47_form_styles.css') }}">
{% endblock %}

{# Contenido principal de la página #}
{% block process_page_content %}
    {# Breadcrumb - Ajustado para apuntar correctamente al blueprint de sellado #}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <a href="{{ url_for('sellado.proceso_sellado_dashboard') }}">
            <i class="fas fa-home" style="margin-right: 0.25rem;"></i> {# Añadido icono de home #}
            Inicio
        </a>
        <span class="separator">›</span> {# Cambiado de &raquo; #}
        <a href="{{ url_for('sellado.proceso_sellado_dashboard') }}">{{ nombre_proceso }}</a>
        <span class="separator">›</span> {# Cambiado de &raquo; #}
        <span class="current-page">{{ subseccion }}</span>
    </nav>

    {# Título y Descripción #}
        <div class="page-title-se30-se47"> {# Clase actualizada #}
            <i class="fas fa-cog"></i> {# Icono actualizado para parámetros #}
            <div>
                <div>{{ subseccion }}</div>
            </div>
        </div>
        <p class="page-description">Ingrese los parámetros de operación para la máquina SE50.</p> {# Texto de descripción actualizado #}


    {# Contenedor para las notificaciones (AJAX) #}
    <div id="notification-container" class="notification-container">
        {# Las notificaciones Toast se insertarán aquí por JavaScript #}
    </div>

    {# Contenedor para tu formulario HTML personalizado #}
    <div class="custom-form-container">

        {# Mostrar mensajes flash de Flask (si se usan para errores no-AJAX o redirecciones) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {# Formulario HTML - Action ajustado para apuntar al blueprint 'se50' #}
        <form id="registroParametrosForm2" method="POST" action="{{ url_for('se50.sellado_form_se50') }}">
            <fieldset>
                <legend>Registro de Parámetros</legend>
                <div class="row" >
                    
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fecha" class="form-label">Fecha:</label>
                            {# El campo de fecha es de solo lectura y se carga con el valor del backend #}
                            <input type="text" class="form-control" name="fecha" id="fecha" value="{{ fecha_actual }}" readonly>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="id_empleado" class="form-label">ID Empleado:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="5" class="form-control" id="id_empleado" name="id_empleado"
                                oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                onchange="consultarEmpleadoPorID()" 
                                value="{{ form_data.id_empleado if form_data.id_empleado is not none else '' }}" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="nombre_empleado" class="form-label">Nombre Empleado:</label>
                            <input type="text" class="form-control" id="nombre_empleado" name="nombre_empleado" 
                                value="{{ form_data.nombre_empleado if form_data.nombre_empleado is not none else '' }}" readonly>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="trabajo" class="form-label">Trabajo:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="8" pattern="^[A-Za-z0-9]{1,8}$"
                                class="form-control" id="trabajo" name="trabajo"
                                oninput="this.value=this.value.replace(/[^A-Za-z0-9]/g,'');"
                                onchange="consultarDatosTrabajo()" 
                                value="{{ form_data.trabajo if form_data.trabajo is not none else '' }}" required>
                        </div>
                    </div> 

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="parte" class="form-label">Parte:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="7" class="form-control" name="parte" id="parte" readonly 
                                value="{{ form_data.parte if form_data.parte is not none else '' }}" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="cliente" class="form-label">Cliente:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="12" class="form-control" name="cliente" id="cliente" 
                            oninput="this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '')"
                                value="{{ form_data.cliente if form_data.cliente is not none else '' }}" required>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="estructura" class="form-label">Estructura:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="12" class="form-control" name="estructura" id="estructura" readonly 
                                value="{{ form_data.estructura if form_data.estructura is not none else '' }}" required>
                        </div>
                    </div>

                   <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="ancho" class="form-label">Ancho:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="20" class="form-control" name="ancho" id="ancho" readonly 
                                value="{{ form_data.ancho if form_data.ancho is not none else '' }}" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="largo" class="form-label">Largo:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="20" class="form-control" name="largo" id="largo" readonly 
                                value="{{ form_data.largo if form_data.largo is not none else '' }}" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fuelle" class="form-label">Fuelle:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="20" class="form-control" name="fuelle" id="fuelle" readonly 
                                value="{{ form_data.fuelle if form_data.fuelle is not none else '' }}" required>
                        </div>
                    </div> 

                    {% set campos_generales = [
                        ('calibre', 3),
                        ('velocidad', 3),
                        ('ajuste_longitud', 5),
                        ('tiempo_avance', 5),
                        ('tiempo_sello', 5),
                        ('tiempo_estabilizacion', 5),
                        ('velocidad_teorica', 3),
                        ('velocidad_real', 3),
                        ('tiempo_perforacion', 5),
                        ('longitud_secundaria', 5),
                        ('compens_avance', 5),
                        ('ajuste_velocidad', 3),
                        ('ciclo_avance', 3)
                    ] %}
                                        
                    {% for nombre_campo, maxlength in campos_generales %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="{{ nombre_campo }}" class="form-label">
                                {{ nombre_campo|replace('_',' ')|capitalize }}:<span class="required-asterisk">*</span>
                            </label>
                            <input type="text" maxlength="{{ maxlength }}" pattern="[0-9.,]{1,{{ maxlength }}}" inputmode="numeric" 
                                class="form-control" name="{{ nombre_campo }}" id="{{ nombre_campo }}" required 
                                oninput="this.value=this.value.replace(/[^0-9.,]/g,'');"
                                value="{{ form_data[nombre_campo] if form_data[nombre_campo] is not none else '' }}">
                        </div>
                    </div>
                    {% endfor %}

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="modo_trabajo" class="form-label">Modo Trabajo:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="modo_trabajo" name="modo_trabajo" required>
                                <option value="">Seleccionar</option>
                                <option value="en_blanco" {% if form_data.modo_trabajo == 'en_blanco' %}selected{% endif %}>En blanco</option>
                                <option value="impreso" {% if form_data.modo_trabajo == 'impreso' %}selected{% endif %}>Impreso</option>
                            </select>
                        </div>
                    </div>

                    {% set modos = ['marca_3', 'modo_saltar', 'modo_perforacion'] %}
                    {% for m in modos %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="{{ m }}" class="form-label">{{ m.replace('_', ' ')|capitalize }}:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="{{ m }}" name="{{ m }}" required>
                                <option value="">Seleccionar</option>
                                <option value="habilitado" {% if form_data.m == 'habilitado' %}selected{% endif %}>Habilitado</option>
                                <option value="deshabilitado" {% if form_data.m == 'deshabilitado' %}selected{% endif %}>Deshabilitado</option>
                            </select>
                        </div>
                    </div>
                    {% endfor %}

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="modo_pouch" class="form-label">Modo Pouch:<span class="required-asterisk">*</span></label>
                            <select class="form-select" id="modo_pouch" name="modo_pouch" required>
                                <option value="">Seleccionar</option>
                                <option value="habilitar" {% if form_data.modo_pouch == 'habilitar' %}selected{% endif %}>Habilitar</option>
                                <option value="inhabilitar" {% if form_data.modo_pouch == 'inhabilitar' %}selected{% endif %}>Inhabilitar</option>
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Tensiones Servo (Derecha / Izquierda)</legend>
                <div class="row">
                    {% for i in range(1, 5) %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="rodillo_servo{{ i }}_der" class="form-label">Rodillo Servo {{ i }} Derecha:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="3" class="form-control" 
                                name="rodillo_servo{{ i }}_der" id="rodillo_servo_{{ i }}_der" required 
                                oninput="this.value=this.value.replace(/[^0-9.,]/g,'');"
                                value="{{ form_data['rodillo_servo' + i|string + '_der'] if form_data['rodillo_servo' + i|string + '_der'] is not none else '' }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="rodillo_servo{{ i }}_izq" class="form-label">Rodillo Servo {{ i }} Izquierda:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="3" class="form-control" 
                                name="rodillo_servo{{ i }}_izq" id="rodillo_servo{{ i }}_izq" required 
                                oninput="this.value=this.value.replace(/[^0-9.,]/g,'');"
                                value="{{ form_data['rodillo_servo' + i|string + '_izq'] if form_data['rodillo_servo' + i|string + '_izq'] is not none else '' }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </fieldset>

            <fieldset>
                <legend>Balancines</legend>
                <div class="row">
                    {% for i in [1, 2] %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="balancin_{{ i }}" class="form-label">Balancín {{ i }}:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="3" class="form-control" name="balancin_{{ i }}" id="balancin_{{ i }}" required oninput="this.value=this.value.replace(/[^0-9.,]/g,'');"
                            value="{{ form_data[balancin_] if form_data[balancin_] is not none else '' }}">
                        </div>
                    </div>
                    {% endfor %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="balancin_3_doypack" class="form-label">Balancín 3 doy pack:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="3" class="form-control" name="balancin_3_doypack" id="balancin_3_doypack" required oninput="this.value=this.value.replace(/[^0-9].,/g,'');"
                            value="{{ form_data[balancin_3_doypack] if form_data[balancin_3_doypack] is not none else '' }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="freno_rodillo" class="form-label">Freno Rodillo:<span class="required-asterisk">*</span></label>
                            <input type="text" maxlength="3" class="form-control" name="freno_rodillo" id="freno_rodillo" required oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                            value="{{ form_data[freno_rodillo] if form_data[freno_rodillo] is not none else '' }}">
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Temperaturas por Módulo</legend>
                    <div class="row">

                        <!-- Sellador válvulas (Preselle) -->
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="sellador_valvulas_preselle_superior_1" class="form-label">Sellador Válvulas -PRESELLE- Superior 1:<span class="required-asterisk">*</span></label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="sellador_valvulas_preselle_superior_1" id="sellador_valvulas_preselle_superior_1" required oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                value="{{ form_data[sellador_valvulas_preselle_superior_1] if form_data[sellador_valvulas_preselle_superior_1] is not none else '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="sellador_valvulas_preselle_inferior_2" class="form-label">Sellador Válvulas - PRESELLE - Inferior 2:<span class="required-asterisk">*</span></label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="sellador_valvulas_preselle_inferior_2" id="sellador_valvulas_preselle_inferior_2" required oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                value="{{ form_data[sellador_valvulas_preselle_inferior_2] if form_data[sellador_valvulas_preselle_inferior_2] is not none else '' }}">
                            </div>
                        </div>

                        <!-- Sellador transversal 19 -->
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="sellador_transversal_superior_9" class="form-label">Sellador Transversal - Superior 9:<span class="required-asterisk">*</span></label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="sellador_transversal_superior_9" id="sellador_transversal_superior_9" required oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                value="{{ form_data[sellador_transversal_superior_9] if form_data[sellador_transversal_superior_9] is not none else '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="sellador_transversal_inferior_10" class="form-label">Sellador Transversal - Inferior 10:<span class="required-asterisk">*</span></label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="sellador_transversal_inferior_10" id="sellador_transversal_inferior_10" required oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                value="{{ form_data[sellador_transversal_inferior_10] if form_data[sellador_transversal_inferior_10] is not none else '' }}">
                            </div>
                        </div>

                        
                        <!-- Selladores Transversales -->
                        {% for i in range(11, 17) %}
                            {% set posicion = 'superior' if i % 2 != 0 else 'inferior' %}
                            <div class="col-md-6">
                                <div class="form-question-card">
                                    <label for="sellador_transversal_{{ posicion }}_{{ i }}" class="form-label">
                                        Sellador Transversal - {{ posicion|capitalize }} {{ i }}:<span class="required-asterisk">*</span>
                                    </label>
                                    <input type="text"
                                        maxlength="3"
                                        pattern="[0-9]{1,3}"
                                        inputmode="numeric"
                                        class="form-control"
                                        name="sellador_transversal_{{ posicion }}_{{ i }}"
                                        id="sellador_transversal_{{ posicion }}_{{ i }}"
                                        required
                                        oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                        value="{{ form_data['sellador_transversal_' ~ posicion ~ '_' ~ i] if form_data['sellador_transversal_' ~ posicion ~ '_' ~ i] is not none else '' }}">
                                </div>
                            </div>
                        {% endfor %}
                        
                        <!-- Selladores Longitudinales -->
                        {% for i in range(17, 23) %}
                            {% set posicion = 'superior' if i % 2 != 0 else 'inferior' %}
                            <div class="col-md-6">
                                <div class="form-question-card">
                                    <label for="sellador_longitudinal_{{ posicion }}_{{ i }}" class="form-label">
                                        Sellador Longitudinal - {{ posicion|capitalize }} {{ i }}:<span class="required-asterisk">*</span>
                                    </label>
                                    <input type="text"
                                        maxlength="3"
                                        pattern="[0-9]{1,3}"
                                        inputmode="numeric"
                                        class="form-control"
                                        name="sellador_longitudinal_{{ posicion }}_{{ i }}"
                                        id="sellador_longitudinal_{{ posicion }}_{{ i }}"
                                        required
                                        oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                        value="{{ form_data['sellador_longitudinal_' ~ posicion ~ '_' ~ i] if form_data['sellador_longitudinal_' ~ posicion ~ '_' ~ i] is not none else '' }}">
                                </div>
                            </div>
                        {% endfor %}
                    </div>
            </fieldset>
            <fieldset>
                <legend>Observaciones</legend>
                <div class="row">
                    <div class="col-12">
                        <div class="form-question-card">
                            <label for="observaciones" class="form-label">Notas / Observaciones:</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="4" maxlength="500"
                                placeholder="Escriba aquí cualquier comentario o novedad relevante..."></textarea>
                        </div>
                    </div>
                </div>
            </fieldset>

            <button type="submit" class="btn btn-success me-2">Enviar Registro</button>
        </form>
    </div>

    {# Botón de Volver #}
    <div class="back-button-container">
        {# La URL para volver debe apuntar al dashboard de sellado, no al de laminación #}
        <a href="{{ url_volver or url_for('sellado.proceso_sellado_dashboard') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Volver a Sellado
        </a>
    </div>
{% endblock %}

{# Script JavaScript para manejar submission AJAX y autocompletado #}
{% block process_page_scripts %}
<script>
    // VERIFICAR SI ESTA ES NECESARIA EN ESTE FORM
    // --- Funciones auxiliares globales para ser accesibles desde onchange/onload ---
    window.mostrarInputFotocelda = function(selectElement) { 
        const container = document.getElementById('fotocelda_otro_container');
        const input = document.getElementById('fotocelda_otro');
        if (!container || !input) return; 
        if (selectElement.value === 'otro') {
            container.style.display = 'block';
            input.required = true;
        } else {
            container.style.display = 'none';
            input.value = '';
            input.required = false;
        }
    };

    window.consultarDatosTrabajo = async function() {
        const trabajoInput = document.getElementById("trabajo");
        const trabajo = trabajoInput.value;
        const parteInput = document.getElementById("parte");
        const estructuraInput = document.getElementById("estructura");
        const clienteInput = document.getElementById("cliente");
        const anchoInput = document.getElementById("ancho");
        const largoInput = document.getElementById("largo");
        const fuelleInput = document.getElementById("fuelle");
        if (!trabajo) {
            parteInput.value = "";
            estructuraInput.value = "";
            clienteInput.value = "";
            clienteInput.removeAttribute("readonly");
            anchoInput.value = "";
            largoInput.value = "";
            fuelleInput.value = "";
            return;
        }
        try {
            const response = await fetch(`/sellado/se50/api/trabajo/${trabajo}`);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || "Error desconocido al consultar trabajo.");
            parteInput.value = data.parte || "";
            estructuraInput.value = data.estructura || "";
            if (data.cliente && data.cliente.trim() !== "") {
                clienteInput.value = data.cliente;
                clienteInput.setAttribute("readonly", "true"); 
            } else {
                clienteInput.value = "";
                clienteInput.removeAttribute("readonly");
            }
            anchoInput.value = data.ancho ? parseFloat(data.ancho).toFixed(2) : "";
            largoInput.value = data.largo ? parseFloat(data.largo).toFixed(2) : "";
            fuelleInput.value = data.fuelle ? parseFloat(data.fuelle).toFixed(2) : "";
        } catch (error) {
            console.error("Error al consultar el trabajo:", error);
            alert(`Error al consultar el trabajo: ${error.message || 'No se encontró el trabajo o hubo un problema de conexión.'}`);
            parteInput.value = "";
            estructuraInput.value = "";
            clienteInput.value = "";
            clienteInput.removeAttribute("readonly");
            anchoInput.value = "";
            largoInput.value = "";
            fuelleInput.value = "";
        }
    };
    
    window.consultarEmpleadoPorID = async function() {
        const idInput = document.getElementById("id_empleado");
        const id = idInput.value;
        const nombreEmpleadoInput = document.getElementById("nombre_empleado");
        if (!id) {
            nombreEmpleadoInput.value = "";
            return;
        }
        try {
            const response = await fetch(`/sellado/se50/api/empleado?id=${id}`);
            const data = await response.json();
            if (data && data.success) {
                nombreEmpleadoInput.value = data.nombre || 'No encontrado';
            } else {
                nombreEmpleadoInput.value = data.nombre || 'No encontrado'; 
            }
        } catch (error) {
            console.error("Error al consultar el empleado:", error);
            nombreEmpleadoInput.value = "Error en la consulta";
        }
    };

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        const btn = form.querySelector('button[type="submit"]');
        const origText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" aria-hidden="true"></span> Enviando...`;

        const payload = {};
        new FormData(form).forEach((value, key) => {
            payload[key] = value;
        });
        // VERIFICAR USO DE ESTA VALIDACION (POR FOTOCELDAS SE47-30)
        const fotoceldaValue = payload['fotocelda'];
        const fotoceldaOtroValue = payload['fotocelda_otro'];
        if (fotoceldaValue !== 'otro') {
            payload['fotocelda_otro'] = null; 
        } else if (fotoceldaOtroValue === undefined || fotoceldaOtroValue.trim() === "") {
            payload['fotocelda_otro'] = null;
        }

        try {
            const res = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            showNotification(result);
            if (res.ok && result.success) {
                form.reset();
                form.querySelectorAll('select').forEach(s => {
                    if (s.options.length > 0) {
                        s.selectedIndex = 0; 
                    }
                });
                mostrarInputFotocelda(document.getElementById('fotocelda'));
                document.getElementById('nombre_empleado').value = "";
                document.getElementById('parte').value = "";
                document.getElementById('cliente').value = "";
                document.getElementById('cliente').removeAttribute('readonly');
                document.getElementById('estructura').value = "";
                document.getElementById('ancho').value = "";
                document.getElementById('largo').value = "";
                document.getElementById('fuelle').value = "";
            } else {
                if (result.form_data) {
                    for (const key in result.form_data) {
                        const input = document.getElementById(key);
                        if (input) {
                            if (input.tagName === 'SELECT') {
                                input.value = result.form_data[key];
                                if (key === 'fotocelda') {
                                    mostrarInputFotocelda(input);
                                }
                            } else {
                                input.value = result.form_data[key];
                            }
                        }
                    }
                    const trabajoInput = document.getElementById('trabajo');
                    if (trabajoInput.value) { 
                        await consultarDatosTrabajo(); 
                    }
                    const empleadoIdInput = document.getElementById('id_empleado');
                    if (empleadoIdInput.value) { 
                        await consultarEmpleadoPorID();
                    }
                }
            }
        } catch (err) {
            console.error('AJAX error:', err);
            showNotification({
                category: 'danger',
                message: 'Error de red o servidor.',
                details: 'Por favor, verifica tu conexión a internet e inténtalo de nuevo.'
            });
        } finally {
            btn.disabled = false;
            btn.innerHTML = origText;
        }
    });

    form.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName === 'INPUT' && e.target.type !== 'submit') {
            e.preventDefault();
        }
    });

    document.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
        input.addEventListener('wheel', e => e.preventDefault());
    });

    const idEmpleadoInput = document.getElementById('id_empleado');
    const trabajoInput = document.getElementById('trabajo');
    const fotoceldaSelect = document.getElementById('fotocelda');
    if (idEmpleadoInput.value) {
        consultarEmpleadoPorID();
    }
    if (trabajoInput.value) {
        consultarDatosTrabajo();
    }
    mostrarInputFotocelda(fotoceldaSelect);

</script>
{% endblock %}