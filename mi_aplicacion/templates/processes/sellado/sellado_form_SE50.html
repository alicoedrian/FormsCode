{% extends "layouts/process_base.html" %}

{# Define el título de la página #}
{% block process_title %}Registro Relación de Mezcla - {{ nombre_proceso }}{% endblock %}

{# Define el CSS específico para esta sección con mejoras de interfaz #}
{% block process_head_css %}
<style>
    /* Estilos existentes para títulos, breadcrumbs, etc. */
    .page-title-sub {
        font-size: 1.9em;
        color: #2C3E50;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        font-weight: 600;
    }
    .page-title-sub i.fa-flask {
        margin-right: 15px;
        color: #007bff;
        font-size: 1.1em;
    }
    .breadcrumb-nav {
        margin-bottom: 30px;
        font-size: 0.95em;
    }
    .breadcrumb-nav a {
        color: #007bff;
        text-decoration: none;
        transition: color 0.2s ease;
    }
    .breadcrumb-nav a:hover {
        color: #0056b3;
        text-decoration: underline;
    }
    .breadcrumb-nav .separator {
        margin: 0 10px;
        color: #adb5bd;
    }
    .breadcrumb-nav .current-page {
        color: #343a40;
        font-weight: 600;
    }

    /* ESTILOS CLAVE PARA EL CONTENEDOR Y AGRUPACIONES DEL FORMULARIO */
    .custom-form-container {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        background-color: #fff;
        padding: 35px;
        margin-bottom: 30px;
    }
    /* Estilo para las leyendas de los fieldset (agrupaciones) */
    .custom-form-container fieldset {
        border: none;
        padding: 0;
        margin-bottom: 25px;
        background-color: transparent;
        box-shadow: none;
    }
    .custom-form-container legend {
        float: none;
        width: auto;
        padding: 0 15px;
        font-size: 1.3em;
        font-weight: bold;
        color: #0056b3;
        border-bottom: none;
        margin-left: 0;
        background-color: transparent;
        border-radius: 0;
        margin-bottom: 20px;
    }

    /* --- ESTILO PARA CADA PREGUNTA INDIVIDUAL (SIMILAR A GOOGLE FORMS) --- */
    .form-question-card {
        background-color: #fff;
        border: 1px solid #dadce0;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 20px; /* Espacio entre cada pregunta */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .form-question-card:hover {
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        border-color: #c9ccd0;
    }

    /* Estilo para el asterisco de requerido */
    .form-label .required-asterisk {
        color: #dc3545;
        margin-left: 4px;
        font-weight: normal;
    }

    /* Ajustes para inputs y selects para SIMETRÍA Y UNIFORMIDAD */
    .form-label {
        font-weight: 400;
        color: #202124;
        font-size: 1em;
        margin-bottom: 12px;
        display: block;
    }
    .form-control, .form-select {
        border-radius: 4px;
        padding: 10px 12px;
        font-size: 1em;
        border: 1px solid #dadce0;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        min-height: 40px;
        box-sizing: border-box;
        background-color: #f8fafd;
    }
    .form-control:focus, .form-select:focus {
        border-color: #1a73e8;
        box-shadow: 0 0 0 1px #1a73e8;
        background-color: #fff;
    }
    .form-text { 
        font-size: 0.85em; 
        color: #5f6368; 
        margin-top: 5px; 
    }

    /* Botones */
    .btn-success {
        padding: 12px 25px;
        font-size: 1.1em;
        border-radius: 8px;
        transition: background-color 0.2s ease, transform 0.1s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-success:hover {
        background-color: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    /* Estilos para el botón de volver */
    .btn-back {
        padding: 12px 25px;
        font-size: 1.05em;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    .btn-back:hover {
        background-color: #5a6268;
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }

    /* Estilos para las NOTIFICACIONES (Toast / Alerta Flotante) */
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        max-width: 350px;
    }
    .toast {
        background-color: #fff;
        border: 1px solid rgba(0,0,0,.1);
        border-radius: .25rem;
        box-shadow: 0 .25rem .75rem rgba(0,0,0,.1);
        padding: .75rem 1.25rem;
        margin-bottom: 1rem;
        transition: opacity .15s linear;
        opacity: 0;
        visibility: hidden;
        color: #212529;
    }
    .toast.show {
        opacity: 1;
        visibility: visible;
    }
    .toast-header {
        display: flex;
        align-items: center;
        padding-bottom: .25rem;
        margin-bottom: .5rem;
        border-bottom: 1px solid rgba(0,0,0,.05);
    }
    .toast-header strong {
        font-weight: 700;
    }
    .toast-body {
        font-size: .875em;
        word-wrap: break-word;
    }
    .toast.bg-success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    .toast.bg-warning { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }
    .toast.bg-danger { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    .toast .btn-close {
        padding: 0.5rem;
        margin-left: auto;
        cursor: pointer;
        background: none;
        border: none;
        font-size: 1em;
        line-height: 1;
        color: inherit;
        opacity: .5;
    }
    .toast .btn-close:hover {
        opacity: .8;
    }

</style>


{% endblock %}

{# Contenido principal de la página #}
{% block process_page_content %}
    {# Breadcrumb #}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <a href="{{ url_for('proceso_laminacion_dashboard') }}">{{ nombre_proceso }}</a>
        <span class="separator">&raquo;</span>
        <span class="current-page">{{ subseccion }}</span>
    </nav>

    {# Título y Descripción #}
    <h1 class="page-title-sub"><i class="fas fa-flask"></i> INSTRUCTIVO SE50</h1>
    <p class="mb-5 text-secondary"></p>

    {# Contenedor para las notificaciones (AJAX) #}
    <div id="notification-container" class="notification-container">
        {# Las notificaciones Toast se insertarán aquí por JavaScript #}
    </div>

    {# Contenedor para tu formulario HTML personalizado #}
    <div class="custom-form-container">
        <form id="registroParametrosForm2" method="POST" action="{{ url_for('proceso_laminacion_form_250') }}">
            <fieldset>
                <legend>Registro de Parámetros</legend>
                <div class="row">
                    {% set campos_generales = [
                        ('calibre', 3),
                        ('velocidad_maquina', 3),
                        ('ajuste_longitud', 5),
                        ('tiempo_avance', 5),
                        ('tiempo_sello', 5),
                        ('tiempo_estabilizacion', 5),
                        ('velocidad_teorica', 3),
                        ('velocidad_real', 3),
                        ('tiempo_perforacion', 5),
                        ('longitud_secundaria', 5),
                        ('compens_avance', 5),
                        ('ajuste_velocidad', 3),
                        ('ciclo_avance', 3)
                    ] %}

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fecha" class="form-label">Fecha:</label>
                            <input type="text" class="form-control" name="fecha" id="fecha" value="{{ fecha_actual }}" readonly>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="id_empleado" class="form-label">ID Empleado:</label>
                            <input type="text" maxlength="5" class="form-control" id="id_empleado" name="id_empleado"
                                oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                onchange="consultarEmpleadoPorID(id_empleado)" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="nombre_empleado" class="form-label">Nombre Empleado:</label>
                            <input type="text" class="form-control" id="nombre_empleado" name="nombre_empleado" readonly>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="trabajo" class="form-label">Trabajo:</label>
                            <input type="text" maxlength="8" pattern="^[A-Za-z0-9]{1,8}$"
                                class="form-control" id="trabajo" name="trabajo"
                                oninput="this.value=this.value.replace(/[^A-Za-z0-9]/g,'');"
                                onchange="consultarDatosTrabajo()" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="parte" class="form-label">Parte:</label>
                            <input type="text" maxlength="7" class="form-control" name="parte" id="parte" readonly required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="cliente" class="form-label">Cliente:</label>
                            <input type="text" maxlength="12" class="form-control" name="cliente" id="cliente"
                            oninput="this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '')"
                            required>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="estructura" class="form-label">Estructura:</label>
                            <input type="text" maxlength="12" class="form-control" name="estructura" id="estructura" readonly required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="ancho" class="form-label">Ancho:</label>
                            <input type="text" maxlength="20" class="form-control" name="ancho" id="ancho" readonly required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="largo" class="form-label">Largo:</label>
                            <input type="text" maxlength="20" class="form-control" name="largo" id="largo" readonly required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="fuelle" class="form-label">Fuelle:</label>
                            <input type="text" maxlength="20" class="form-control" name="fuelle" id="fuelle" readonly required>
                        </div>
                    </div>

                    {% for nombre, maxlength in campos_generales %}
                        {% if nombre in ['parte', 'cliente'] %}
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="{{ nombre }}" class="form-label">{{ nombre.replace('_', ' ')|capitalize }}:</label>
                                <input type="text" maxlength="{{ maxlength }}" class="form-control" name="{{ nombre }}" id="{{ nombre }}" required oninput="this.value=this.value.replace(/[^A-Za-z0-9.,]/g,'');">
                            </div>
                        </div>
                        {% else %}
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="{{ nombre }}" class="form-label">{{ nombre.replace('_', ' ')|capitalize }}:</label>
                                <input type="text" maxlength="{{ maxlength }}" class="form-control" name="{{ nombre }}" id="{{ nombre }}" required oninput="this.value=this.value.replace(/[^0-9.,]/g,'');">
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}

                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="modo_trabajo" class="form-label">Modo Trabajo:</label>
                            <select class="form-select" id="modo_trabajo" name="modo_trabajo" required>
                                <option value="print stand">En blanco</option>
                                <option value="plain">Impreso</option>
                            </select>
                        </div>
                    </div>

                    {% set modos = ['Marca 3', 'modo_saltar', 'modo_perforacion'] %}
                    {% for m in modos %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="{{ m }}" class="form-label">{{ m.replace('_', ' ')|capitalize }}:</label>
                            <select class="form-select" id="{{ m }}" name="{{ m }}" required>
                                <option value="enable">Habilitado</option>
                                <option value="disable">Deshabilitado</option>
                            </select>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="modo_pouch" class="form-label">Modo Pouch:</label>
                            <select class="form-select" id="modo_pouch" name="modo_pouch" required>
                                <option value="habilitar">Habilitar</option>
                                <option value="inhabilitar">Inhabilitar</option>
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Tensiones Servo (Derecha / Izquierda)</legend>
                <div class="row">
                    {% for i in range(1, 5) %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="servo_{{ i }}_der" class="form-label">Rodillo Servo {{ i }} Derecha:</label>
                            <input type="text" maxlength="3" class="form-control" name="servo_{{ i }}_der" id="servo_{{ i }}_der" required oninput="this.value=this.value.replace(/[^0-9.,]/g,'');">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="servo_{{ i }}_izq" class="form-label">Rodillo Servo {{ i }} Izquierda:</label>
                            <input type="text" maxlength="3" class="form-control" name="servo_{{ i }}_izq" id="servo_{{ i }}_izq" required oninput="this.value=this.value.replace(/[^0-9.,]/g,'');">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </fieldset>

            <fieldset>
                <legend>Balancines</legend>
                <div class="row">
                    {% for i in [1, 2] %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="balancin_{{ i }}" class="form-label">Balancín {{ i }}:</label>
                            <input type="text" maxlength="3" class="form-control" name="balancin_{{ i }}" id="balancin_{{ i }}" required oninput="this.value=this.value.replace(/[^0-9.,]/g,'');">
                        </div>
                    </div>
                    {% endfor %}
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="balancin_doypack_3" class="form-label">Balancín 3 doy pack:</label>
                            <input type="text" maxlength="3" class="form-control" name="balancin_doypack_3" id="balancin_doypack_3" required oninput="this.value=this.value.replace(/[^0-9].,/g,'');">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-question-card">
                            <label for="freno_rodillo" class="form-label">Freno Rodillo:</label>
                            <input type="text" maxlength="3" class="form-control" name="freno_rodillo" id="freno_rodillo" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Temperaturas por Módulo</legend>
                    <div class="row">

                        <!-- Sellador válvulas (Preselle) -->
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="temp_1" class="form-label">Sellador Válvulas -PRESELLE- Superior 1:</label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="temp_1" id="temp_1" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="temp_2" class="form-label">Sellador Válvulas - PRESELLE - Inferior 2:</label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="temp_2" id="temp_2" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                            </div>
                        </div>

                        <!-- Sellador transversal 19 -->
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="temp_9" class="form-label">Sellador Transversal - Superior 9:</label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="temp_9" id="temp_9" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="temp_10" class="form-label">Sellador Transversal - Inferior 10:</label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="temp_10" id="temp_10" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                            </div>
                        </div>

                        <!-- Sellador transversal 20 -->
                        {% for i in [11, 12, 13, 14, 15, 16] %}
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="temp_{{ i }}" class="form-label">Sellador Transversal - {{ 'Superior' if i % 2 != 0 else 'Inferior' }} {{ i }}:</label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="temp_{{ i }}" id="temp_{{ i }}" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Sellador longitudinal -->
                        {% for i in [17, 18, 19, 20, 21, 22] %}
                        <div class="col-md-6">
                            <div class="form-question-card">
                                <label for="temp_{{ i }}" class="form-label">Sellador Longitudinal - {{ 'Superior' if i % 2 != 0 else 'Inferior' }} {{ i }}:</label>
                                <input type="text" maxlength="3" pattern="[0-9]{1,3}" inputmode="numeric" class="form-control" name="temp_{{ i }}" id="temp_{{ i }}" required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
            </fieldset>


            <button type="submit" class="btn btn-success me-2">Enviar Registro</button>
        </form>
    </div>

    {# Botón de Volver #}
    <div class="back-button-container">
        <a href="{{ url_volver or url_for('proceso_laminacion_dashboard') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Volver a Opciones de Laminación
        </a>
    </div>
{% endblock %}

{# Script JavaScript para manejar submission AJAX y truncar decimales en tiempo real #}
{% block process_page_scripts %}
<script>


    function consultarDatosTrabajo() {
        const trabajo = document.getElementById("trabajo").value;
        if (!trabajo) return;

        fetch(`/api/trabajo/${trabajo}`)
            .then(response => {
                if (!response.ok) throw new Error("Trabajo no encontrado");
                return response.json();
            })
            .then(data => {
                document.getElementById("parte").value = data.parte || "";
                document.getElementById("estructura").value = data.estructura || "";

                // 🟡 Lógica especial para el campo CLIENTE
                const clienteInput = document.getElementById("cliente");
                if (data.cliente && data.cliente.trim() !== "") {
                    clienteInput.value = data.cliente;
                    clienteInput.setAttribute("readonly", true);
                } else {
                    clienteInput.value = "";
                    clienteInput.removeAttribute("readonly");
                }

                // ✅ Otros campos formateados con dos decimales
                document.getElementById("ancho").value = data.ancho ? parseFloat(data.ancho).toFixed(2) : "";
                document.getElementById("largo").value = data.largo ? parseFloat(data.largo).toFixed(2) : "";
                document.getElementById("fuelle").value = data.fuelle ? parseFloat(data.fuelle).toFixed(2) : "";
            })
            .catch(error => {
                console.error("Error:", error);
                alert("No se encontró el trabajo o hubo un error al consultar la API.");
            });
    }

    async function consultarEmpleadoPorID(id_empleado) {
        const id = document.getElementById("id_empleado").value;
        if (!id) return;

        try {
            const response = await fetch(`/api/empleado?id=${id}`);
            const data = await response.json();

            if (data && data.nombre) {
                document.getElementById("nombre_empleado").value = data.nombre;
            } else {
                document.getElementById("nombre_empleado").value = "No encontrado";
            }
        } catch (error) {
            console.error("Error al consultar el empleado:", error);
            document.getElementById("nombre_empleado").value = "Error en la consulta";
        }
    }
</script>
{% endblock %}