{% extends "layouts/process_base.html" %}

{% block process_title %}Registro Relación de Mezcla{% endblock %}

{% block process_head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/css4.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/registro_mezcla_form_styles.css') }}">
{% endblock %}

{% block process_page_content %}
    {# Breadcrumb - Ajustado para apuntar correctamente al blueprint de sellado #}
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
 <a href="{{ url_for('laminacion.proceso_laminacion_dashboard') }}">
            <i class="fas fa-home" style="margin-right: 0.25rem;"></i> {# Añadido icono de home #}
            Inicio
        </a>
        <span class="separator">›</span> {# Cambiado de &raquo; #}
        <a href="{{ url_for('laminacion.proceso_laminacion_dashboard') }}">{{ nombre_proceso }}</a>
        <span class="separator">›</span> {# Cambiado de &raquo; #}
        <span class="current-page">{{ subseccion }}</span>
    </nav>

    <h1 class="page-title-sub"><i class="fas fa-cogs"></i> {{ subseccion }}</h1>
    <p class="mb-5 text-secondary" style="animation: fadeInUp 0.6s ease-out forwards; animation-delay: 0.15s; opacity: 0;">Ingrese la información del proceso.</p>

    <div id="notification-container" class="notification-container"></div>

    <div class="custom-form-container">
        {# Contenedor para las notificaciones flash de Flask #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form id="relacionMezclasForm" method="POST" action="{{ url_for('laminacion.proceso_laminacion_form_mezclas') }}">
            <fieldset>
                <legend>Datos de la Mezcla</legend>
                <div class="form-fields-grid">
                    <div class="form-question-card">
                        <label for="maquina" class="form-label">Máquina <span class="required-asterisk">*</span></label>
                        <select class="form-select" id="maquina" name="maquina" required>
                            <option value="" disabled selected>Selecciona una máquina</option>
                            <option value="LA02 - ITALAM" {% if form_data.maquina == 'LA02 - ITALAM' %}selected{% endif %}>LA02 - ITALAM</option>
                            <option value="LA03 - DUAL 1" {% if form_data.maquina == 'LA03 - DUAL 1' %}selected{% endif %}>LA03 - DUAL 1</option>
                            <option value="LA04 - EVO 1" {% if form_data.maquina == 'LA04 - EVO 1' %}selected{% endif %}>LA04 - EVO 1</option>
                            <option value="LA05 - DUAL 2" {% if form_data.maquina == 'LA05 - DUAL 2' %}selected{% endif %}>LA05 - DUAL 2</option>
                            <option value="LA06 - EVO 2" {% if form_data.maquina == 'LA06 - EVO 2' %}selected{% endif %}>LA06 - EVO 2</option>
                        </select>
                    </div>
                    <div class="form-question-card">
                        <label for="turno" class="form-label">Turno <span class="required-asterisk">*</span></label>
                        <select class="form-select" id="turno" name="turno" required>
                            <option value="" disabled selected>Selecciona un turno</option>
                            <option value="TURNO 1 (9:30PM - 5:30AM)" {% if form_data.turno == 'TURNO 1 (9:30PM - 5:30AM)' %}selected{% endif %}>TURNO 1 (9:30PM - 5:30AM)</option>
                            <option value="TURNO 2 (5:30AM - 1:30 PM)" {% if form_data.turno == 'TURNO 2 (5:30AM - 1:30 PM)' %}selected{% endif %}>TURNO 2 (5:30AM - 1:30 PM)</option>
                            <option value="TURNO 3 (1:30 PM - 9:30 PM)" {% if form_data.turno == 'TURNO 3 (1:30 PM - 9:30 PM)' %}selected{% endif %}>TURNO 3 (1:30 PM - 9:30 PM)</option>
                            <option value="TURNO L-J (DIURNO)" {% if form_data.turno == 'TURNO L-J (DIURNO)' %}selected{% endif %}>TURNO L-J (DIURNO)</option>
                            <option value="TURNO L-J (NOCTURNO)" {% if form_data.turno == 'TURNO L-J (NOCTURNO)' %}selected{% endif %}>TURNO L-J (NOCTURNO)</option>
                            <option value="TURNO V-D (DIURNO)" {% if form_data.turno == 'TURNO V-D (DIURNO)' %}selected{% endif %}>TURNO V-D (DIURNO)</option>
                            <option value="TURNO V-D (NOCTURNO)" {% if form_data.turno == 'TURNO V-D (NOCTURNO)' %}selected{% endif %}>TURNO V-D (NOCTURNO)</option>
                        </select>
                    </div>
                    {# --- NUEVO CAMPO: Referencia de Adhesivo --- #}
                    <div class="form-question-card">
                        <label for="referencia_adhesivo" class="form-label">Referencia de adhesivo <span class="required-asterisk">*</span></label>
                        <select class="form-select" id="referencia_adhesivo" name="referencia_adhesivo" required>
                            {# Por ahora, solo una opción predeterminada. Puedes agregar más aquí en el futuro. #}
                            <option value="HENKEL LIOFOL LA 3824 DR" selected>HENKEL LIOFOL LA 3824 DR</option>
                        </select>
                    </div>
                    {# --- FIN NUEVO CAMPO --- #}
                    <div class="form-question-card">
                        <label for="peso_adhesivo" class="form-label">Peso adhesivo (kg) <span class="required-asterisk">*</span></label>
                        <input type="number" step="0.01" class="form-control" id="peso_adhesivo" name="peso_adhesivo" required placeholder="Ej. 10.50" value="{{ form_data.peso_adhesivo | default('') }}">
                    </div>
                    <div class="form-question-card">
                        <label for="peso_correactante" class="form-label">Peso correactante (kg) <span class="required-asterisk">*</span></label>
                        <input type="number" step="0.01" class="form-control" id="peso_correactante" name="peso_correactante" required placeholder="Ej. 1.23" value="{{ form_data.peso_correactante | default('') }}">
                    </div>
                    <div class="form-question-card">
                        <label for="relacion_mezcla" class="form-label">Relación de mezcla <span class="required-asterisk">*</span></label>
                        <input type="number" step="0.01" class="form-control" id="relacion_mezcla" name="relacion_mezcla" required placeholder="Ej. 5.67" value="{{ form_data.relacion_mezcla | default('') }}">
                    </div>
                </div>
            </fieldset>

            <button type="submit" class="btn-submit mt-4">Enviar Registro</button>
        </form>
    </div>

    <div class="back-button-container">
        <a href="{{ url_for('laminacion.proceso_laminacion_dashboard') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Volver a {{ nombre_proceso }}
        </a>
    </div>
{% endblock %}

{% block process_page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('relacionMezclasForm');
    if (!form) return;

            // Función mejorada para mostrar notificaciones (similar a empalme_turno_form)
            function showNotification(response) {
                const container = document.getElementById('notification-container');
                if (!container) return;

                container.innerHTML = '';

                const alert = document.createElement('div');
                alert.className = `alert alert-${response.category} alert-dismissible`;

                let icon = '';
                if (response.category === 'success') {
                    icon = '<i class="fas fa-check-circle me-2"></i>';
                } else if (response.category === 'danger') {
                    icon = '<i class="fas fa-exclamation-circle me-2"></i>';
                } else if (response.category === 'warning') {
                    icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
                } else {
                    icon = '<i class="fas fa-info-circle me-2"></i>';
                }

                let detailsHtml = '';
                if (response.details) {
                    detailsHtml = `<div class="small mt-1">${response.details}</div>`;
                } else if (response.data && response.data.relacion_calculada) {
                    detailsHtml = `<div class="small mt-1">Relación calculada: ${response.data.relacion_calculada}</div>`;
                    if (response.data.id_registro_webhook) {
                        detailsHtml += `<div class="small mt-1">ID de registro: ${response.data.id_registro_webhook}</div>`;
                    }
                }

                alert.innerHTML = `
                    <div class="d-flex align-items-center">
                        ${icon}
                        <div>
                            <strong>${response.message}</strong>
                            ${detailsHtml}
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;

                container.appendChild(alert);

                // --- Scroll automático para que el usuario vea el mensaje ---
                window.scrollTo({ top: 0, behavior: 'smooth' });

                alert.querySelector('.btn-close').onclick = () => alert.remove();

                if (response.category === 'success' || response.category === 'warning') {
                    setTimeout(() => {
                        if (alert && alert.parentNode) {
                            alert.remove();
                        }
                    }, 8000);
                }
            }



    // --- Repoblación de datos del formulario (para errores de validación) ---
    const form_data = JSON.parse('{{ form_data | tojson | safe }}');
    if (Object.keys(form_data).length > 0) {
        // Seleccionar los campos 'select' y establecer su valor
        const selectFields = ['maquina', 'turno', 'referencia_adhesivo']; // Añadido referencia_adhesivo
        selectFields.forEach(field => {
            const selectElement = document.getElementById(field);
            if (selectElement && form_data[field]) {
                selectElement.value = form_data[field];
            }
        });
        // Los inputs numéricos ya se repoblan con value="{{ form_data.campo }}"
    }

    // Manejar envío del formulario
    form.addEventListener('submit', async function(e) {
        e.preventDefault(); // Detener el envío tradicional del formulario
        e.stopImmediatePropagation(); // Detener cualquier otro listener de submit

        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;

        submitButton.disabled = true; // Deshabilitar botón para evitar envíos duplicados
        submitButton.innerHTML = `
            <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
            Enviando datos...
        `;

        try {
            const formData = new FormData(form);
            // Convertir FormData a un objeto plano para JSON
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // Indicar que enviamos JSON
                    'X-Requested-With': 'XMLHttpRequest' // Encabezado para detectar AJAX en Flask
                },
                body: JSON.stringify(data) // Enviar los datos como JSON
            });

            const result = await response.json(); // Siempre esperamos un JSON

            if (response.ok) { // Si la respuesta HTTP fue 2xx (200, 201, etc.)
                if (result.success) {
                    form.reset(); // Resetear el formulario
                    // Asegurarse de que los selects vuelvan a la opción por defecto (Selecciona...)
                    document.querySelectorAll('select').forEach(s => {
                        // Para este formulario, solo resetea los que tienen una opción "Selecciona..."
                        if (s.querySelector('option[disabled][selected]')) {
                            s.selectedIndex = 0;
                        }
                    });

                    showNotification(result); // Mostrar notificación de éxito o advertencia

                    setTimeout(() => document.querySelector('select').focus(), 100);
                } else {
                    // Si response.ok es true, pero result.success es false (ej. errores de validación 400)
                    showNotification(result);
                }
            } else { // Si la respuesta HTTP no fue 2xx (ej. 400 Bad Request, 500 Internal Server Error)
                // Si el backend envía 400/500 con JSON de error
                showNotification(result);
            }

        } catch (error) {
            console.error('Error en el envío del formulario:', error);
            showNotification({
                message: error.message || 'Error al procesar la solicitud',
                category: 'danger',
                details: 'Por favor, intenta nuevamente.'
            });
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalText; // Restaurar texto original del botón
        }
    });

    // Prevenir el envío del formulario con la tecla Enter en los inputs
    form.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const activeElement = document.activeElement;
            // Solo prevenir si el elemento activo es un input y no un textarea o botón
            if (activeElement && activeElement.tagName === 'INPUT' && activeElement.type !== 'submit') {
                e.preventDefault();
            }
        }
    });

    // --- JavaScript para deshabilitar el scroll en campos numéricos (inputs type="number") ---
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('wheel', function(e) {
            // Previene la acción por defecto del evento de la rueda del ratón
            // cuando el cursor está sobre este input.
            e.preventDefault();
        });
    });
});
</script>
{% endblock %}
